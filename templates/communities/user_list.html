{% extends 'base.html' %}
{% load messaging_extras %}

{% block title %}Baselist - GrwComm{% endblock %}

{% block extra_css %}
<style>
.message-type-btn {
    transition: all 0.2s ease;
}

.message-type-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.message-type-btn:disabled {
    opacity: 0.6;
    transform: none !important;
    cursor: not-allowed;
}

.message-type-btn.cursor-not-allowed {
    cursor: not-allowed;
    opacity: 0.6;
}

/* Mobile-specific styles - Ultra Compact */
@media (max-width: 768px) {
    /* Ultra small font sizes */
    body {
        font-size: 12px !important;
    }
    
    h1 {
        font-size: 1.125rem !important; /* 18px */
        margin-bottom: 0.25rem;
    }
    
    h2 {
        font-size: 1rem !important; /* 16px */
        margin-bottom: 0.25rem;
    }
    
    h3 {
        font-size: 0.875rem !important; /* 14px */
        margin-bottom: 0.125rem;
    }
    
    .container {
        padding: 0.5rem !important;
    }
    
    /* Ultra compact cards */
    .card {
        margin-bottom: 0.5rem;
        padding: 0 !important;
        border-radius: 0.5rem;
    }
    
    /* Tiny avatars */
    .avatar {
        width: 2rem !important;
        height: 2rem !important;
        font-size: 0.75rem;
    }
    
    /* 50% smaller buttons */
    .btn {
        padding: 4px 8px !important;
        font-size: 11px !important;
        min-height: 24px !important;
        border-radius: 4px;
    }
    
    .btn-sm {
        padding: 3px 6px !important;
        font-size: 10px !important;
        min-height: 20px !important;
    }
    
    /* Minimal spacing */
    .mb-3 {
        margin-bottom: 0.25rem !important;
    }
    
    .mb-6 {
        margin-bottom: 0.5rem !important;
    }
    
    .p-4 {
        padding: 0.5rem !important;
    }
    
    .p-3 {
        padding: 0.5rem !important;
    }
    
    .py-2 {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }
    
    .px-3 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
    }
    
    /* Ultra compact text */
    .text-base {
        font-size: 0.875rem !important; /* 14px */
    }
    
    .text-sm {
        font-size: 0.75rem !important; /* 12px */
    }
    
    .text-xs {
        font-size: 0.625rem !important; /* 10px */
    }
    
    /* Minimal input fields */
    .input {
        min-height: 28px !important;
        padding: 4px 8px !important;
        font-size: 12px !important;
    }
    
    /* Ultra small badges */
    .badge {
        padding: 1px 4px !important;
        font-size: 0.625rem !important;
        border-radius: 3px;
    }
    
    /* Modal specific */
    #userModal {
        font-size: 12px;
    }
    
    #modalContent {
        border-radius: 12px 12px 0 0;
    }
    
    /* Message type buttons in modal */
    .msg-type-btn {
        padding: 4px 6px !important;
        font-size: 10px !important;
        min-height: 24px !important;
        border-radius: 4px;
    }
    
    /* Mobile user list rows - better spacing */
    .user-row {
        padding: 0.75rem 1rem !important;
        min-height: 60px;
    }
    
    .user-row img, .user-row > div > div:first-child {
        width: 40px !important;
        height: 40px !important;
    }
    
    /* Modal sizes */
    #modalAvatar {
        width: 36px !important;
        height: 36px !important;
        font-size: 14px !important;
    }
    
    /* Search form compact */
    form label {
        font-size: 11px !important;
        margin-bottom: 2px !important;
    }
    
    /* Hide scroll indicator on ultra small */
    .bg-blue-50.border-b {
        display: none !important;
    }
}

/* Animation for mobile forms */
@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
    }
    to {
        opacity: 1;
        max-height: 500px;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
    }
}

/* Horizontal scroll for desktop table on smaller screens */
@media (min-width: 769px) and (max-width: 1024px) {
    .table-container {
        overflow-x: auto;
    }
}

/* Loading spinner for better UX */
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-light text-black">Baselist</h1>
        <div class="text-sm text-gray-600">{{ total_users }} members</div>
    </div>

    <!-- Unified Search Bar -->
    <div class="card mb-6">
        <form method="GET" class="flex space-x-3">
            <div class="flex-1 relative">
                <input 
                    type="text" 
                    name="q" 
                    value="{{ search_query }}"
                    placeholder="Search by name, company, location, tags, skills, or any combination..."
                    class="input w-full px-4"
                    autofocus
                >
            </div>
            <button type="submit" class="px-6 py-2 bg-black text-white text-sm font-medium rounded hover:bg-gray-800 transition-colors">
                Search
            </button>
            {% if search_query %}
            <a href="{% url 'communities:user_list' %}" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded hover:bg-gray-300 transition-colors">
                Clear
            </a>
            {% endif %}
        </form>
        {% if search_query %}
        <div class="mt-2 text-sm text-gray-600">
            Searching for: <span class="font-medium text-black">{{ search_query }}</span>
        </div>
        {% endif %}
    </div>

    <!-- Community Table -->
    <div class="card overflow-hidden">
        
        <!-- Desktop table view -->
        <div class="hidden md:block table-container">
            <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Location</th>
                    <th>Company</th>
                    <th>Team</th>
                    <th>Org Level</th>
                    <th>Education</th>
                    <th>Tags</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            {% if user.profile.profile_picture %}
                                <img src="{{ user.profile.profile_picture.url }}" alt="{{ user.profile.display_name }}" class="h-8 w-8 rounded-full object-cover mr-3">
                            {% else %}
                                <div class="avatar avatar-white avatar-sm mr-3">
                                    {{ user.profile.display_name|first }}
                                </div>
                            {% endif %}
                            <div class="text-sm font-medium text-black">{{ user.profile.display_name }}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ user.profile.location|default:"-" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ user.profile.company|default:"-" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ user.profile.team|default:"-" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {% if user.profile.organization_level %}
                            <span class="badge">
                                {{ user.profile.get_organization_level_display }}
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ user.profile.schools|default:"-" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {% if user.profile.tag_list %}
                            {% for tag in user.profile.tag_list|slice:":2" %}
                                <span class="badge mr-1">
                                    {{ tag }}
                                </span>
                            {% endfor %}
                            {% if user.profile.tag_list|length > 2 %}
                                <span class="text-xs text-gray-400">+{{ user.profile.tag_list|length|add:"-2" }}</span>
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <!-- Always show dropdown button for all users -->
                        <button 
                            onclick="toggleUserDetails({{ user.id }})" 
                            class="text-gray-600 hover:text-black"
                            title="{% if request.user.is_superuser or user_is_verified %}Send message{% else %}View messaging options{% endif %}"
                        >
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </td>
                </tr>
                <!-- Expandable user details and message form row - FULL SCREEN -->
                <tr id="message-form-{{ user.id }}" class="hidden">
                    <td colspan="8" class="px-4 py-6 bg-gray-50 border-t border-gray-200">
                        <div class="max-w-4xl mx-auto space-y-6">
                            
                            <!-- User Profile Details Section -->
                            <div class="bg-white rounded-lg p-5 shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    {% if user.profile.profile_picture %}
                                        <img src="{{ user.profile.profile_picture.url }}" alt="{{ user.profile.display_name }}" class="h-8 w-8 rounded-full object-cover mr-3">
                                    {% else %}
                                        <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-medium text-gray-600 mr-3">
                                            {{ user.first_name.0|default:user.username.0|upper }}
                                        </div>
                                    {% endif %}
                                    {{ user.profile.display_name }} - Profile Details
                                </h3>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Left Column - Personal Info -->
                                    <div class="space-y-4">
                                        <h4 class="font-medium text-gray-700 text-sm border-b border-gray-200 pb-2">Personal Information</h4>
                                        
                                        {% if user.profile.bio %}
                                        <div>
                                            <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Bio</span>
                                            <p class="text-sm text-gray-700 mt-1 leading-relaxed">{{ user.profile.bio }}</p>
                                        </div>
                                        {% endif %}
                                        
                                        {% if user.profile.schools %}
                                        <div>
                                            <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Education</span>
                                            <div class="text-sm text-gray-700 mt-1">
                                                {% for school in user.profile.school_list %}
                                                    <div class="py-1">â€¢ {{ school }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if user.profile.tag_list %}
                                        <div>
                                            <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Skills & Interests</span>
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                {% for tag in user.profile.tag_list %}
                                                    <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-medium">{{ tag }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Right Column - Professional Info -->
                                    <div class="space-y-4">
                                        <h4 class="font-medium text-gray-700 text-sm border-b border-gray-200 pb-2">Professional Details</h4>
                                        
                                        <div class="grid grid-cols-1 gap-3">
                                            {% if user.profile.company %}
                                            <div>
                                                <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Company</span>
                                                <p class="text-sm text-gray-700">{{ user.profile.company }}</p>
                                            </div>
                                            {% endif %}
                                            
                                            {% if user.profile.team %}
                                            <div>
                                                <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Team</span>
                                                <p class="text-sm text-gray-700">{{ user.profile.team }}</p>
                                            </div>
                                            {% endif %}
                                            
                                            {% if user.profile.get_organization_level_display %}
                                            <div>
                                                <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Career Level</span>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    {{ user.profile.get_organization_level_display }}
                                                </span>
                                            </div>
                                            {% endif %}
                                            
                                            {% if user.profile.location %}
                                            <div>
                                                <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Location</span>
                                                <p class="text-sm text-gray-700">{{ user.profile.location }}</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Message Section -->
                            <div class="bg-white rounded-lg p-5 shadow-sm border border-gray-200">
                                <h4 class="font-medium text-gray-800 text-base mb-4">Send Message</h4>
                                
                                <!-- Message type selection -->
                                <div class="mb-4">
                                    <label class="text-sm font-medium text-gray-700 mb-2 block">Select Message Category:</label>
                                    <div class="flex flex-wrap gap-2">
                                        {% with user_slots=users_slot_data|dict_get:user.id %}
                                        {% for slot_key, slot_info in user_slots.items %}
                                            <button 
                                                onclick="{% if request.user.is_superuser or user_is_verified %}selectMessageType({{ user.id }}, '{{ slot_info.message_type.name }}'){% else %}showVerificationRequired(){% endif %}" 
                                                class="btn message-type-btn
                                                    {% if not user_is_verified and not request.user.is_superuser %}btn-ghost cursor-not-allowed
                                                    {% elif slot_info.status == 'available' %}btn-secondary
                                                    {% elif slot_info.status == 'already_sent' %}btn-ghost cursor-not-allowed
                                                    {% elif slot_info.status == 'full' %}btn-ghost cursor-not-allowed{% endif %}"
                                                {% if slot_info.status != 'available' or not user_is_verified and not request.user.is_superuser %}disabled{% endif %}
                                                title="{% if not user_is_verified and not request.user.is_superuser %}Get verified to send messages{% endif %}"
                                            >
                                                {{ slot_info.message_type.name }}
                                                <span class="ml-1 text-xs
                                                    {% if slot_info.status == 'available' %}text-green-600
                                                    {% elif slot_info.status == 'already_sent' %}text-gray-500
                                                    {% elif slot_info.status == 'full' %}text-red-600{% endif %}
                                                ">
                                                    {% if slot_info.status == 'available' %}
                                                        ({{ slot_info.available_slots }}/{{ slot_info.total_slots }})
                                                    {% elif slot_info.status == 'already_sent' %}
                                                        âœ“ Sent
                                                    {% elif slot_info.status == 'full' %}
                                                        (Full)
                                                    {% endif %}
                                                </span>
                                            </button>
                                        {% endfor %}
                                        {% endwith %}
                                    </div>
                                </div>
                                
                                <!-- Message input -->
                                <div class="mb-4">
                                    <label class="text-sm font-medium text-gray-700 mb-2 block">Your Message:</label>
                                    <textarea 
                                        id="message-text-{{ user.id }}" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent {% if not user_is_verified and not request.user.is_superuser %}bg-gray-100 cursor-not-allowed{% endif %}" 
                                        rows="4" 
                                        placeholder="{% if request.user.is_superuser or user_is_verified %}Write your message here...{% else %}Get verified to send messages...{% endif %}"
                                        {% if not user_is_verified and not request.user.is_superuser %}disabled readonly{% endif %}
                                    ></textarea>
                                </div>
                                
                                <div class="flex justify-end space-x-3">
                                    <button 
                                        onclick="toggleUserDetails({{ user.id }})" 
                                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                                        Cancel
                                    </button>
                                    <button 
                                        onclick="{% if request.user.is_superuser or user_is_verified %}sendMessage({{ user.id }}){% else %}showVerificationRequired(){% endif %}" 
                                        class="px-4 py-2 {% if request.user.is_superuser or user_is_verified %}bg-blue-600 hover:bg-blue-700 text-white{% else %}bg-gray-300 text-gray-500 cursor-not-allowed{% endif %} rounded-md transition-colors"
                                        {% if not user_is_verified and not request.user.is_superuser %}disabled title="Get verified to send messages"{% endif %}>
                                        {% if request.user.is_superuser or user_is_verified %}Send Message{% else %}ðŸ”’ Get Verified to Send{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
        
        <!-- Mobile list view - Minimal -->
        <div class="block md:hidden">
            {% for user in users %}
                <div class="border-b border-gray-200 last:border-b-0 mb-2 px-3 py-2">
                    <!-- Minimal User Row -->
                    <button 
                        class="w-full flex items-center hover:bg-gray-50 transition-colors user-row"
                        onclick="openUserModal({{ user.id }})"
                        data-user-id="{{ user.id }}"
                        data-user-name="{{ user.profile.display_name }}"
                        data-user-location="{{ user.profile.location|default:'' }}"
                        data-user-company="{{ user.profile.company|default:'' }}"
                        data-user-team="{{ user.profile.team|default:'' }}"
                        data-user-level="{{ user.profile.get_organization_level_display|default:'' }}"
                        data-user-schools="{{ user.profile.schools|default:'' }}"
                        data-user-bio="{{ user.profile.bio|default:'' }}"
                        data-user-tags="{{ user.profile.tag_list|join:', ' }}"
                    >
                        <div class="flex items-center flex-1">
                            {% if user.profile.profile_picture %}
                                <img src="{{ user.profile.profile_picture.url }}" alt="{{ user.profile.display_name }}" class="w-8 h-8 rounded-full object-cover mr-3 border border-gray-200">
                            {% else %}
                                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-medium text-gray-600 mr-3 border border-gray-200">
                                    {{ user.profile.display_name|first }}
                                </div>
                            {% endif %}
                            <div class="text-left flex-1">
                                <div class="text-base font-medium text-gray-900 mb-1">{{ user.profile.display_name }}</div>
                                <div class="text-sm text-gray-500">{{ user.profile.location|default:"" }}{% if user.profile.company %} â€¢ {{ user.profile.company }}{% endif %}</div>
                            </div>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Mobile User Modal -->
    <div id="userModal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeUserModal()"></div>
        
        <!-- Modal Content -->
        <div class="absolute inset-x-0 bottom-0 bg-white rounded-t-xl max-h-[90vh] overflow-hidden transform transition-transform duration-300 translate-y-full" id="modalContent">
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white border-b border-gray-200 px-3 py-2 flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-900" id="modalUserName">User Details</h3>
                <button onclick="closeUserModal()" class="p-1 rounded-full hover:bg-gray-100">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="overflow-y-auto" style="max-height: calc(90vh - 60px);">
                <!-- User Info -->
                <div class="px-3 py-2 space-y-2 border-b border-gray-100">
                    <div class="flex items-center space-x-2">
                        <div id="modalAvatar" class="rounded-full bg-gray-200 flex items-center justify-center font-medium text-gray-600">
                            U
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-900" id="modalName">Name</div>
                            <div class="text-xs text-gray-500" id="modalLocation">Location</div>
                        </div>
                    </div>
                    
                    <!-- Complete User Profile Information -->
                    <div class="space-y-3 text-xs">
                        <!-- Bio Section -->
                        <div id="modalBioSection">
                            <div class="font-medium text-gray-500 mb-1">Bio</div>
                            <div class="text-gray-700 leading-relaxed" id="modalBio">-</div>
                        </div>
                        
                        <!-- Professional Details -->
                        <div>
                            <div class="font-medium text-gray-500 mb-2">Professional Details</div>
                            <div class="space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Company:</span>
                                    <span class="text-gray-700 text-right flex-1 ml-2" id="modalCompany">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Team:</span>
                                    <span class="text-gray-700 text-right flex-1 ml-2" id="modalTeam">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Career Level:</span>
                                    <span class="text-gray-700 text-right flex-1 ml-2" id="modalLevel">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Education Section -->
                        <div id="modalEducationSection">
                            <div class="font-medium text-gray-500 mb-1">Education</div>
                            <div class="text-gray-700" id="modalSchools">-</div>
                        </div>
                        
                        <!-- Skills & Interests Section -->
                        <div id="modalTagsSection">
                            <div class="font-medium text-gray-500 mb-1">Skills & Interests</div>
                            <div id="modalTags" class="flex flex-wrap gap-1">
                                <span class="text-gray-400 text-xs">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Message Section -->
                <div class="px-3 py-2">
                    <div class="text-xs font-medium text-gray-700 mb-2">Send Message</div>
                    
                    <!-- Message Categories -->
                    <div class="grid grid-cols-2 gap-1 mb-2" id="modalMessageTypes">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <!-- Message Input -->
                    <textarea 
                        id="modalMessageText" 
                        class="w-full px-2 py-1.5 text-xs border border-gray-200 rounded focus:outline-none focus:border-blue-400" 
                        rows="3" 
                        placeholder="Type your message..."
                    ></textarea>
                    
                    <!-- Send Button -->
                    <button 
                        onclick="sendModalMessage()" 
                        class="w-full mt-2 px-3 py-1.5 bg-blue-500 text-white text-xs font-medium rounded hover:bg-blue-600 transition-colors"
                    >
                        Send Message
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// Make slot data available to JavaScript
window.usersSlotData = {{ users_slot_data_json|safe }};
console.log('All users slot data loaded:', window.usersSlotData);

let selectedMessageType = {};
let currentUserId = null;
let selectedMessageCategory = null;

// Mobile Modal Functions
function openUserModal(userId) {
    currentUserId = userId;
    const userRow = document.querySelector(`[data-user-id="${userId}"]`);
    
    if (!userRow) return;
    
    // Get user data from attributes
    const userName = userRow.dataset.userName || 'Anonymous';
    const userLocation = userRow.dataset.userLocation || '';
    const userCompany = userRow.dataset.userCompany || '';
    const userTeam = userRow.dataset.userTeam || '';
    const userLevel = userRow.dataset.userLevel || '';
    const userSchools = userRow.dataset.userSchools || '';
    const userBio = userRow.dataset.userBio || '';
    const userTags = userRow.dataset.userTags || '';
    
    // Update modal content
    document.getElementById('modalUserName').textContent = userName;
    document.getElementById('modalName').textContent = userName;
    document.getElementById('modalLocation').textContent = userLocation || 'Location not provided';
    document.getElementById('modalCompany').textContent = userCompany || 'Not specified';
    document.getElementById('modalTeam').textContent = userTeam || 'Not specified';  
    document.getElementById('modalLevel').textContent = userLevel || 'Not specified';
    
    // Handle bio section - always show section
    const bioText = document.getElementById('modalBio');
    if (userBio && userBio.trim()) {
        bioText.textContent = userBio;
        bioText.className = 'text-gray-700 leading-relaxed';
    } else {
        bioText.textContent = 'No bio provided';
        bioText.className = 'text-gray-400 leading-relaxed text-xs';
    }
    
    // Handle education section - show full schools information
    const schoolsText = document.getElementById('modalSchools');
    if (userSchools && userSchools.trim()) {
        // Split schools by line or comma and display as list
        const schoolList = userSchools.split(/[,\n]/).map(s => s.trim()).filter(s => s);
        if (schoolList.length > 1) {
            schoolsText.innerHTML = schoolList.map(school => `â€¢ ${school}`).join('<br>');
        } else {
            schoolsText.textContent = userSchools;
        }
        schoolsText.className = 'text-gray-700';
    } else {
        schoolsText.textContent = 'No education information provided';
        schoolsText.className = 'text-gray-400 text-xs';
    }
    
    // Update avatar
    const avatarDiv = document.getElementById('modalAvatar');
    avatarDiv.textContent = userName.charAt(0).toUpperCase();
    
    // Handle tags section - show full tags information
    const tagsContainer = document.getElementById('modalTags');
    tagsContainer.innerHTML = '';
    if (userTags && userTags.trim()) {
        const tagList = userTags.split(',').map(tag => tag.trim()).filter(tag => tag);
        if (tagList.length > 0) {
            tagList.forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.className = 'px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded font-medium';
                tagSpan.textContent = tag; // Show full tag text without truncation
                tagsContainer.appendChild(tagSpan);
            });
        } else {
            tagsContainer.innerHTML = '<span class="text-gray-400 text-xs">No skills/interests specified</span>';
        }
    } else {
        tagsContainer.innerHTML = '<span class="text-gray-400 text-xs">No skills/interests specified</span>';
    }
    
    // Populate message types
    populateMessageTypes(userId);
    
    // Show modal
    const modal = document.getElementById('userModal');
    const modalContent = document.getElementById('modalContent');
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('translate-y-full');
    }, 10);
}

function closeUserModal() {
    const modal = document.getElementById('userModal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.classList.add('translate-y-full');
    setTimeout(() => {
        modal.classList.add('hidden');
        currentUserId = null;
        selectedMessageCategory = null;
        document.getElementById('modalMessageText').value = '';
    }, 300);
}

function populateMessageTypes(userId) {
    const container = document.getElementById('modalMessageTypes');
    container.innerHTML = '';
    
    // Get slot data for this user (try both string and number keys)
    const userSlotData = window.usersSlotData ? (window.usersSlotData[userId] || window.usersSlotData[userId.toString()]) : {};
    
    // Debug logging for development (remove in production)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('User ID:', userId);
        console.log('User Slot Data:', userSlotData);
    }
    
    // Get message types from user's slot data (both default and custom)
    const messageTypes = [];
    
    if (userSlotData) {
        Object.keys(userSlotData).forEach(slotKey => {
            const slotInfo = userSlotData[slotKey];
            if (slotInfo.message_type) {
                messageTypes.push({
                    id: slotInfo.message_type.id || slotInfo.custom_slot_id,
                    name: slotInfo.message_type.name,
                    is_custom: slotInfo.is_custom || false
                });
            }
        });
    }
    
    messageTypes.forEach(type => {
        const btn = document.createElement('button');
        btn.className = 'px-2 py-2 text-xs border border-gray-200 rounded hover:bg-blue-50 hover:border-blue-400 transition-colors msg-type-btn text-center';
        
        // Get slot status for this message type using the same key transformation as desktop
        const slotKey = type.name.toLowerCase().replace(/ /g, '_');
        const slotInfo = userSlotData[slotKey] || {};
        
        let statusText = '';
        let statusClass = '';
        let canSend = true;
        
        if (slotInfo.status === 'already_sent') {
            statusText = 'Sent';
            statusClass = 'text-orange-600';
            canSend = false;
        } else if (slotInfo.status === 'full') {
            statusText = 'Full';
            statusClass = 'text-red-600';
            canSend = false;
        } else if (slotInfo.status === 'available' && slotInfo.available_slots && slotInfo.total_slots) {
            statusText = `${slotInfo.available_slots}/${slotInfo.total_slots}`;
            statusClass = 'text-green-600';
            canSend = true;
        } else {
            statusText = 'Available';
            statusClass = 'text-green-600';
            canSend = true;
        }
        
        btn.innerHTML = `
            <div class="font-medium text-xs leading-tight">${type.name}</div>
            <div class="text-xs ${statusClass} mt-0.5">${statusText}</div>
        `;
        
        if (!canSend) {
            btn.disabled = true;
            btn.className += ' opacity-50 cursor-not-allowed';
        }
        
        btn.onclick = canSend ? () => selectMessageCategory(type.id, type.name) : null;
        container.appendChild(btn);
    });
}

function selectMessageCategory(typeId, typeName) {
    selectedMessageCategory = typeName;
    
    // Update button styles
    const buttons = document.querySelectorAll('.msg-type-btn');
    buttons.forEach(btn => {
        if (btn.querySelector('div').textContent.includes(typeName)) {
            btn.classList.add('bg-blue-50', 'border-blue-400');
        } else {
            btn.classList.remove('bg-blue-50', 'border-blue-400');
        }
    });
}

function sendModalMessage() {
    const messageText = document.getElementById('modalMessageText').value;
    
    if (!selectedMessageCategory) {
        alert('Please select a message category');
        return;
    }
    
    if (!messageText.trim()) {
        alert('Please enter a message');
        return;
    }
    
    // Send message via existing sendMessage function
    sendMessageFromModal(currentUserId, selectedMessageCategory, messageText);
}

function sendMessageFromModal(userId, messageType, messageText) {
    fetch('/community/send-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            'to_user_id': userId,
            'message_type': messageType,
            'message_content': messageText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeUserModal();
            showNotification('Message sent successfully!', 'success');
            setTimeout(() => {
                window.location.href = '/messages/';
            }, 1500);
        } else {
            showNotification('Error: ' + (data.error || 'Failed to send'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error sending message', 'error');
    });
}

// Legacy functions for desktop
function toggleUserDetails(userId) {
    const messageForm = document.getElementById(`message-form-${userId}`);
    if (messageForm) {
        messageForm.classList.toggle('hidden');
    }
}

function selectMessageType(userId, type) {
    // Check if button is disabled (for already sent or full slots)
    const parentRow = document.getElementById(`message-form-${userId}`);
    const clickedButton = Array.from(parentRow.querySelectorAll('.message-type-btn'))
        .find(btn => btn.textContent.trim().includes(type));
    
    if (clickedButton && clickedButton.disabled) {
        return; // Don't allow selection of disabled buttons
    }
    
    selectedMessageType[userId] = type;
    // Update button styles
    const buttons = parentRow.querySelectorAll('.message-type-btn');
    buttons.forEach(btn => {
        if (btn.textContent.trim().includes(type) && !btn.disabled) {
            btn.className = 'btn message-type-btn px-3 py-2 text-sm bg-white text-black rounded transition-all transform scale-105 white-glow';
        } else if (!btn.disabled) {
            btn.className = 'btn btn-secondary message-type-btn';
        }
        // Keep disabled buttons with their original styling
    });
}

function sendMessage(userId) {
    const messageText = document.getElementById(`message-text-${userId}`).value;
    const messageType = selectedMessageType[userId];
    const sendButton = document.querySelector(`#message-form-${userId} button[onclick="sendMessage(${userId})"]`);
    
    if (!messageType) {
        showNotification('Please select a message type', 'warning');
        return;
    }
    
    if (!messageText.trim()) {
        showNotification('Please enter a message', 'warning');
        return;
    }
    
    // Show loading state
    sendButton.disabled = true;
    sendButton.innerHTML = '<span class="loading-spinner"></span> Sending...';
    sendButton.className = 'btn btn-ghost cursor-not-allowed';
    
    // Send via AJAX
    fetch('/community/send-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            'to_user_id': userId,
            'message_type': messageType,
            'message_content': messageText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Message sent successfully! Redirecting to chat...', 'success');
            
            // Clear form and hide
            document.getElementById(`message-text-${userId}`).value = '';
            toggleUserDetails(userId);
            selectedMessageType[userId] = null;
            
            // Redirect to messages page after a short delay
            setTimeout(() => {
                window.location.href = '/messages/';
            }, 1500);
        } else {
            if (data.verification_required) {
                showNotification('You need more referrals to send messages.', 'warning');
                // Redirect to referrals page after showing message
                setTimeout(() => {
                    window.location.href = '/invites/';
                }, 2000);
            } else {
                showNotification('Error sending message: ' + (data.error || 'Unknown error'), 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error sending message. Please try again.', 'error');
    })
    .finally(() => {
        // Restore button state
        sendButton.disabled = false;
        sendButton.innerHTML = 'Send Message';
        sendButton.className = 'btn btn-primary text-sm';
    });
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white font-medium z-50 transform transition-all duration-300 translate-x-full max-w-sm mx-4 md:mx-0`;
    
    // Set color based on type
    switch(type) {
        case 'success':
            notification.style.background = '#10B981';
            break;
        case 'error':
            notification.style.background = '#EF4444';
            break;
        case 'warning':
            notification.style.background = '#F59E0B';
            break;
        default:
            notification.style.background = '#3B82F6';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 10);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

function showVerificationRequired() {
    showNotification('You need 3 referrals to send messages. Check your verification status!', 'warning');
    // Redirect to invites/referrals page after showing message
    setTimeout(() => {
        window.location.href = '/invites/';
    }, 2000);
}
</script>
{% endblock %}