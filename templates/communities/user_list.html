{% extends 'base.html' %}

{% block title %}Baselist - GrowCommunity{% endblock %}

{% block extra_css %}
<style>
.message-type-btn {
    transition: all 0.2s ease;
}

.message-type-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-light text-black">Baselist</h1>
        <div class="text-sm text-gray-600">{{ total_users }} members</div>
    </div>

    <!-- Search and Filter Form -->
    <div class="card mb-6">
        <form method="GET" class="flex space-x-4">
            <div class="flex-1">
                {{ form.search }}
            </div>
            <div class="w-48">
                {{ form.organization_level }}
            </div>
            <div class="w-48">
                {{ form.tags }}
            </div>
            <button type="submit" class="btn btn-primary">
                Search
            </button>
        </form>
    </div>

    <!-- Community Table -->
    <div class="card overflow-hidden">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Location</th>
                    <th>Company</th>
                    <th>Team</th>
                    <th>Org Level</th>
                    <th>Education</th>
                    <th>Tags</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in page_obj %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            {% if user.profile.profile_picture %}
                                <img src="{{ user.profile.profile_picture.url }}" alt="{{ user.profile.display_name }}" class="h-8 w-8 rounded-full object-cover mr-3">
                            {% else %}
                                <div class="avatar avatar-white avatar-sm mr-3">
                                    {{ user.first_name|first|default:user.username|first }}
                                </div>
                            {% endif %}
                            <div class="text-sm font-medium text-black">{{ user.profile.display_name|default:"Anonymous" }}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ user.profile.location|default:"-" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ user.profile.company|default:"-" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ user.profile.team|default:"-" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {% if user.profile.organization_level %}
                            <span class="badge">
                                {{ user.profile.get_organization_level_display }}
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ user.profile.schools|default:"-" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {% if user.profile.tag_list %}
                            {% for tag in user.profile.tag_list|slice:":2" %}
                                <span class="badge mr-1">
                                    {{ tag }}
                                </span>
                            {% endfor %}
                            {% if user.profile.tag_list|length > 2 %}
                                <span class="text-xs text-gray-400">+{{ user.profile.tag_list|length|add:"-2" }}</span>
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        {% if request.user.is_superuser or user_is_verified %}
                            <button 
                                onclick="toggleUserDetails({{ user.id }})" 
                                class="text-gray-600 hover:text-black"
                                title="Send message"
                            >
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        {% else %}
                            <button 
                                onclick="showVerificationRequired()" 
                                class="text-gray-400 cursor-not-allowed"
                                title="Get verified to send messages"
                            >
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        {% endif %}
                    </td>
                </tr>
                <!-- Expandable message form row -->
                <tr id="message-form-{{ user.id }}" class="hidden">
                    <td colspan="8" class="px-6 py-4 bg-gray-800">
                        <div class="max-w-2xl">
                            <div class="mb-4">
                                <label class="form-label">Select Message Type:</label>
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <button onclick="selectMessageType({{ user.id }}, 'Coffee Chat')" class="btn btn-secondary message-type-btn">
                                        ‚òï Coffee Chat
                                    </button>
                                    <button onclick="selectMessageType({{ user.id }}, 'Mentorship')" class="btn btn-secondary message-type-btn">
                                        üéì Mentorship
                                    </button>
                                    <button onclick="selectMessageType({{ user.id }}, 'Networking')" class="btn btn-secondary message-type-btn">
                                        ü§ù Networking
                                    </button>
                                    <button onclick="selectMessageType({{ user.id }}, 'General')" class="btn btn-secondary message-type-btn">
                                        üí¨ General
                                    </button>
                                    <button onclick="selectMessageType({{ user.id }}, 'Collaboration')" class="btn btn-secondary message-type-btn">
                                        ü§ù Collaboration
                                    </button>
                                    <button onclick="selectMessageType({{ user.id }}, 'Job Opportunity')" class="btn btn-secondary message-type-btn">
                                        üíº Job Opportunity
                                    </button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Your Message:</label>
                                <textarea 
                                    id="message-text-{{ user.id }}" 
                                    class="input" 
                                    rows="3" 
                                    placeholder="Write your message here..."
                                ></textarea>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button 
                                    onclick="toggleUserDetails({{ user.id }})" 
                                    class="btn btn-ghost">
                                >
                                    Cancel
                                </button>
                                <button 
                                    onclick="sendMessage({{ user.id }})" 
                                    class="btn btn-primary text-sm">
                                    üí¨ Send Message
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="flex justify-center mt-6">
        <nav class="flex space-x-2">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-secondary">Previous</a>
            {% endif %}
            <span class="px-3 py-2 text-sm bg-gray-100 border border-gray-300 text-black rounded">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="btn btn-secondary">Next</a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<script>
let selectedMessageType = {};

function toggleUserDetails(userId) {
    const messageForm = document.getElementById(`message-form-${userId}`);
    messageForm.classList.toggle('hidden');
}

function selectMessageType(userId, type) {
    selectedMessageType[userId] = type;
    // Update button styles
    const parentRow = document.getElementById(`message-form-${userId}`);
    const buttons = parentRow.querySelectorAll('.message-type-btn');
    buttons.forEach(btn => {
        if (btn.textContent.trim().includes(type)) {
            btn.className = 'message-type-btn px-3 py-2 text-sm bg-white text-black rounded transition-all transform scale-105 white-glow';
        } else {
            btn.className = 'btn btn-secondary message-type-btn';
        }
    });
}

function sendMessage(userId) {
    const messageText = document.getElementById(`message-text-${userId}`).value;
    const messageType = selectedMessageType[userId];
    const sendButton = document.querySelector(`#message-form-${userId} button[onclick="sendMessage(${userId})"]`);
    
    if (!messageType) {
        showNotification('Please select a message type', 'warning');
        return;
    }
    
    if (!messageText.trim()) {
        showNotification('Please enter a message', 'warning');
        return;
    }
    
    // Show loading state
    sendButton.disabled = true;
    sendButton.innerHTML = '<span class="loading-spinner"></span> Sending...';
    sendButton.className = 'btn btn-ghost cursor-not-allowed';
    
    // Send via AJAX
    fetch('/community/send-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            'to_user_id': userId,
            'message_type': messageType,
            'message_content': messageText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Message sent successfully! Redirecting to chat...', 'success');
            
            // Clear form and hide
            document.getElementById(`message-text-${userId}`).value = '';
            toggleUserDetails(userId);
            selectedMessageType[userId] = null;
            
            // Redirect to messages page after a short delay
            setTimeout(() => {
                window.location.href = '/messages/';
            }, 1500);
        } else {
            if (data.verification_required) {
                showNotification('You need more referrals to send messages.', 'warning');
                // Redirect to referrals page after showing message
                setTimeout(() => {
                    window.location.href = '/invites/';
                }, 2000);
            } else {
                showNotification('Error sending message: ' + (data.error || 'Unknown error'), 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error sending message. Please try again.', 'error');
    })
    .finally(() => {
        // Restore button state
        sendButton.disabled = false;
        sendButton.innerHTML = 'Send Message';
        sendButton.className = 'btn btn-primary text-sm';
    });
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-black bg-white border border-gray-300 font-medium z-50 transform transition-all duration-300 translate-x-full`;
    
    // Set color based on type
    switch(type) {
        case 'success':
            notification.style.background = '#10B981';
            break;
        case 'error':
            notification.style.background = '#EF4444';
            break;
        case 'warning':
            notification.style.background = '#F59E0B';
            break;
        default:
            notification.style.background = '#3B82F6';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 10);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

function showVerificationRequired() {
    showNotification('You need 3 referrals to send messages. Check your verification status!', 'warning');
    // Redirect to invites/referrals page after showing message
    setTimeout(() => {
        window.location.href = '/invites/';
    }, 2000);
}
</script>
{% endblock %}