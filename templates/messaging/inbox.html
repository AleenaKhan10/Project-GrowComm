{% extends 'base.html' %}

{% block title %}Messages - GrwComm{% endblock %}

{% block content %}
<script>
// Add messages-page class to body to prevent scrolling
document.body.classList.add('messages-page');
</script>
<div class="messages-container">
    <!-- Left Sidebar - Conversations List -->
    <div class="sidebar">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <h2 class="text-xl font-semibold text-black mb-4 flex items-center">
                <svg class="w-6 h-6 mr-3 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.966 8.966 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"/>
                </svg>
                Conversations
            </h2>
            
            <!-- Search Box -->
            <div class="relative mb-4">
                <input 
                    id="conversation-search"
                    type="text" 
                    class="input text-sm w-full pl-10"
                >
                <svg class="absolute left-3 top-3 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
        </div>
        
        <!-- Conversations List -->
        <div class="conversation-list">
            <div id="conversations-container">
                {% if conversations %}
                    {% for conversation in conversations %}
                        <div class="conversation-item {% if forloop.first %}active{% endif %}" 
                             data-user-id="{{ conversation.other_user.id }}"
                             data-user-name="{{ conversation.display_name|escapejs }}"
                             data-last-seen="{{ conversation.other_user.profile.last_seen_display|escapejs }}"
                             data-message-type-id="{% if conversation.message_type %}{{ conversation.message_type.id }}{% else %}null{% endif %}"
                             data-message-type-name="{% if conversation.message_type %}{{ conversation.message_type.name|escapejs }}{% else %}General{% endif %}">
                            
                            <div class="flex items-center space-x-3">
                                <!-- Avatar -->
                                <div class="relative flex-shrink-0">
                                    {% if conversation.other_user.profile.avatar_url %}
                                        <img src="{{ conversation.other_user.profile.avatar_url }}" 
                                             alt="{{ conversation.display_name }}" 
                                             class="avatar">
                                    {% else %}
                                        {% if conversation.other_user.id|divisibleby:6 %}
                                            <div class="avatar avatar-gray-1">
                                        {% elif conversation.other_user.id|add:1|divisibleby:6 %}
                                            <div class="avatar avatar-gray-2">
                                        {% elif conversation.other_user.id|add:2|divisibleby:6 %}
                                            <div class="avatar avatar-gray-3">
                                        {% elif conversation.other_user.id|add:3|divisibleby:6 %}
                                            <div class="avatar avatar-white">
                                        {% elif conversation.other_user.id|add:4|divisibleby:6 %}
                                            <div class="avatar avatar-purple">
                                        {% else %}
                                            <div class="avatar avatar-teal">
                                        {% endif %}
                                            {{ conversation.display_name.0|upper }}
                                        </div>
                                    {% endif %}
                                    
                                </div>
                                
                                <!-- Conversation Info -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-sm font-semibold text-black truncate">
                                                {{ conversation.display_name }}
                                            </h3>
                                            {% if conversation.chat_heading %}
                                                <p class="text-xs text-blue-600 font-medium truncate chat-heading-display">
                                                    üìù {{ conversation.chat_heading }}
                                                </p>
                                            {% endif %}
                                            <p class="text-xs text-gray-500 truncate">
                                                Last seen: {{ conversation.other_user.profile.last_seen_display }}
                                            </p>
                                        </div>
                                        <span class="text-xs text-gray-500 flex-shrink-0 ml-2">
                                            {{ conversation.latest_message.timestamp|timesince }} ago
                                        </span>
                                    </div>
                                    
                                    {% if conversation.message_type %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 mb-1">
                                            {{ conversation.message_type.name }}
                                        </span>
                                    {% endif %}
                                    
                                    <p class="text-sm text-gray-600 truncate">
                                        {% if conversation.latest_message %}
                                            {% if conversation.latest_message.sender_id == user.id %}
                                                <span class="font-medium text-black">You:</span>
                                            {% endif %}
                                            {{ conversation.latest_message.content|truncatewords:6 }}
                                        {% else %}
                                            No messages yet
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.966 8.966 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"/>
                            </svg>
                        </div>
                        <p class="text-gray-600 text-sm">No conversations yet</p>
                        <a href="{% url 'communities:user_list' %}" class="btn btn-ghost mt-3 text-sm">
                            Browse Community
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Right Chat Area -->
    <div class="chat-area">
        <!-- Chat Header -->
        <div id="chat-header" class="chat-header hidden">
            <div class="flex items-center space-x-4">
                <!-- Mobile back button -->
                <button class="mobile-back-button p-2 text-gray-600 hover:text-black rounded-lg hover:bg-gray-100 transition-all duration-200 md:hidden" title="Back to conversations">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                
                <!-- Chat Avatar -->
                <div class="relative">
                    <div id="chat-avatar" class="avatar avatar-white">
                        A
                    </div>
                    <div class="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-gray-600 border-2 border-white rounded-full"></div>
                </div>
                
                <!-- Chat Info -->
                <div class="flex-1">
                    <h3 id="chat-name" class="text-lg font-semibold text-black leading-tight">Select a conversation</h3>
                    <p id="chat-status" class="text-sm text-gray-600">
                        Last seen: <span id="last-seen-time">Select a conversation</span>
                    </p>
                </div>

                <!-- Reveal Identity Button -->
                <div class="flex-shrink-0">
                    <button id="reveal-identity-btn" class="hidden flex items-center space-x-2 px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors mr-2" onclick="revealIdentity()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        <span class="hidden sm:inline">Reveal Identity</span>
                    </button>
                </div>

                <!-- Schedule Meeting Button -->
                <div class="flex-shrink-0">
                    <button id="schedule-meeting-btn" class="flex items-center space-x-2 px-3 py-2 bg-black text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-colors" onclick="scheduleMeeting()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        <span class="hidden sm:inline">Meeting</span>
                    </button>
                </div>
            </div>
            
            <!-- Action Button - Positioned at the end -->
            <div class="flex-shrink-0 ml-auto">
                <!-- Report/Unblock Button -->
                <button id="report-user-btn" class="flex items-center space-x-1 px-2 py-1.5 bg-black text-white text-xs font-medium rounded-lg hover:bg-gray-800 transition-colors" onclick="handleReportOrUnblock()" title="Report/Unblock User">
                    <svg id="report-icon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <span id="report-btn-text" class="hidden sm:inline">Report</span>
                </button>
            </div>
        </div>
        
        <!-- Messages Area -->
        <div class="messages-list">
            <div id="messages-list" class="space-y-4">
                <!-- Messages will be loaded here -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center">
                <div class="relative w-20 h-20 bg-gray-100 border border-gray-300 rounded-full flex items-center justify-center mb-6 white-glow">
                    <svg class="w-10 h-10 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.966 8.966 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"/>
                    </svg>
                </div>
                
                <h3 class="text-2xl font-bold text-black mb-3">Welcome to Messages</h3>
                <p class="text-gray-600 mb-8 max-w-md">Select a conversation from the sidebar to start messaging with community members</p>
                
                <div class="card max-w-md">
                    <p class="text-gray-600 text-sm">Start a conversation by selecting someone from the sidebar or use the "New Message" button to find community members.</p>
                </div>
            </div>
        </div>
        
        <!-- Message Input Area -->
        <div id="message-input-area" class="message-input-container hidden">
            <div class="flex items-center space-x-3 w-full">
                <!-- Attachment button -->
                <button class="btn btn-ghost p-3" title="Attach file">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                    </svg>
                </button>
                
                <!-- Message input container -->
                <div class="flex-1 relative">
                    {% if user.is_superuser or user.profile.is_verified and not user.profile.is_suspended %}
                        <div class="bg-white rounded-full border border-gray-300 hover:border-black transition-all duration-200 focus-within:ring-2 focus-within:ring-black focus-within:border-black">
                            <textarea 
                                id="message-input" 
                                class="w-full px-4 py-3 bg-transparent border-0 rounded-full resize-none focus:outline-none placeholder-gray-400 text-black max-h-20 min-h-[44px]" 
                                rows="1" 
                                placeholder="Type your message..."
                            ></textarea>
                        </div>
                    {% else %}
                        <div class="bg-gray-100 rounded-full border border-gray-200 relative">
                            <textarea 
                                id="message-input" 
                                class="w-full px-4 py-3 bg-transparent border-0 rounded-full resize-none placeholder-gray-400 text-gray-500 max-h-20 min-h-[44px]" 
                                rows="1" 
                                placeholder="{% if user.profile.is_suspended %}Account suspended - cannot send messages...{% else %}Get verified to send messages...{% endif %}"
                                readonly
                                disabled
                            ></textarea>
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Emoji button -->
                <button class="btn btn-ghost p-3" title="Add emoji">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
                
                <!-- Send button -->
                {% if user.is_superuser or user.profile.is_verified and not user.profile.is_suspended %}
                    <button 
                        id="send-button" 
                        class="btn btn-primary p-3 white-glow"
                        title="Send message"
                        disabled
                    >
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                        </svg>
                    </button>
                {% else %}
                    <button 
                        id="send-button" 
                        class="btn btn-gray p-3 cursor-not-allowed"
                        title="{% if user.profile.is_suspended %}Account suspended - cannot send messages{% else %}Get verified to send messages{% endif %}"
                        disabled
                    >
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
class MessagingApp {
    constructor() {
        this.currentUserId = null;
        this.currentMessageTypeId = null;
        this.isLoading = false;
        this.messagePolling = null;
        this.lastMessageCount = 0;
        this.searchTimeout = null;
        this.lastSeenInterval = null;
        
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.setupMessageInput();
        this.autoSelectFirstConversation();
        this.addCustomStyles();
    }
    
    addCustomStyles() {
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes slideIn {
                from { opacity: 0; transform: translateX(20px); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            @keyframes slideInLeft {
                from { opacity: 0; transform: translateX(-20px); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            .animate-fade-in {
                animation: fadeIn 0.3s ease-out;
            }
            
            .animate-slide-in {
                animation: slideIn 0.3s ease-out;
            }
            
            .animate-slide-in-left {
                animation: slideInLeft 0.3s ease-out;
            }
            
            .message-enter {
                animation: slideIn 0.3s ease-out;
            }
            
            /* Message bubble styles */
            .message-bubble {
                padding: 8px 12px;
                border-radius: 12px;
                max-width: 280px;
                word-wrap: break-word;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                position: relative;
            }
            
            .message-sent {
                background: #007bff !important; /* Blue background for sent messages */
                color: white !important;
                border-bottom-right-radius: 4px;
            }
            
            .message-sent p {
                color: white !important;
            }
            
            .message-received {
                background: #f1f3f5 !important;
                color: #333 !important;
                border-bottom-left-radius: 4px;
            }
            
            .message-received p {
                color: #333 !important;
            }
            
            /* Avatar multi-color borders */
            .avatar-gray-1 {
                background: var(--color-gray-200) !important;
                color: var(--color-pure-black) !important;
                border: 2px solid #e74c3c !important; /* Red border */
            }
            
            .avatar-gray-2 {
                background: var(--color-gray-300) !important;
                color: var(--color-pure-black) !important;
                border: 2px solid #3498db !important; /* Blue border */
            }
            
            .avatar-gray-3 {
                background: var(--color-gray-100) !important;
                color: var(--color-pure-black) !important;
                border: 2px solid #2ecc71 !important; /* Green border */
            }
            
            .avatar-white {
                background: var(--color-pure-white) !important;
                color: var(--color-pure-black) !important;
                border: 2px solid #f39c12 !important; /* Orange border */
            }
            
            /* Additional avatar color variations for more variety */
            .avatar-purple {
                background: var(--color-gray-200) !important;
                color: var(--color-pure-black) !important;
                border: 2px solid #9b59b6 !important; /* Purple border */
            }
            
            .avatar-teal {
                background: var(--color-gray-100) !important;
                color: var(--color-pure-black) !important;
                border: 2px solid #1abc9c !important; /* Teal border */
            }
            
            /* ULTRA AGGRESSIVE Mobile Messaging Optimization */
            @media (max-width: 768px) {
                /* FORCE body and html reset */
                html, body {
                    font-size: 14px !important;
                    overflow: hidden !important;
                    height: 100vh !important;
                    margin: 0 !important;
                    padding: 0 !important;
                }
                
                /* SELECTIVE OVERFLOW FIXES - PRESERVE FUNCTIONALITY */
                
                /* ONLY TARGET VISUAL ELEMENTS THAT CAUSE SCROLLBAR ISSUES */
                .message-bubble,
                .message-bubble *,
                .conversation-item,
                .conversation-item *,
                .chat-header,
                .chat-header *:not(button):not(svg),
                .sidebar-header,
                .sidebar-header *:not(input):not(button):not(svg) {
                    overflow: hidden !important;
                    overflow-x: hidden !important;
                    overflow-y: hidden !important;
                }
                
                /* PRESERVE INTERACTIVE ELEMENTS */
                button, input, textarea, select,
                .conversation-item[data-user-id],
                #message-input,
                #send-button,
                .mobile-back-button {
                    overflow: visible !important;
                }
                
                /* MAIN SCROLLABLE CONTAINERS */
                .messages-list, .conversation-list {
                    overflow-y: auto !important;
                    overflow-x: hidden !important;
                }
                
                /* PREVENT HORIZONTAL SCROLL ONLY ON MAIN CONTAINERS */
                .messages-container,
                .sidebar,
                .chat-area {
                    overflow-x: hidden !important;
                }
                
                .messages-page {
                    overflow: hidden !important;
                    height: 100vh !important;
                }
                
                /* MAIN CONTAINER - FULL SCREEN */
                .messages-container {
                    position: fixed !important;
                    top: 64px !important; /* Account for nav */
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    width: 100vw !important;
                    height: calc(100vh - 64px) !important;
                    max-height: calc(100vh - 64px) !important;
                    display: flex !important;
                    flex-direction: row !important;
                    background: #f8f9fa !important;
                    z-index: 1 !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    overflow: hidden !important;
                }
                
                /* SIDEBAR - Initially full width */
                .sidebar {
                    width: 100% !important;
                    min-width: 100% !important;
                    max-width: 100% !important;
                    height: 100% !important;
                    display: flex !important;
                    flex-direction: column !important;
                    background: white !important;
                    position: relative !important;
                    z-index: 2 !important;
                    overflow: hidden !important;
                    margin: 0 !important;
                    padding: 0 !important;
                }
                
                .chat-area {
                    display: none !important;
                    width: 100% !important;
                    height: 100% !important;
                    flex-direction: column !important;
                    background: white !important;
                    position: relative !important;
                    overflow: hidden !important;
                }
                
                /* CHAT ACTIVE STATE - Hide sidebar, show chat */
                .messages-container.chat-active .sidebar {
                    display: none !important;
                }
                
                .messages-container.chat-active .chat-area {
                    display: flex !important;
                }
                
                /* SIDEBAR HEADER - Compact */
                .sidebar-header {
                    flex-shrink: 0 !important;
                    padding: 0.75rem !important;
                    background: white !important;
                    border-bottom: 1px solid #e5e7eb !important;
                }
                
                .sidebar-header h2 {
                    font-size: 1rem !important;
                    margin-bottom: 0.5rem !important;
                    color: black !important;
                    font-weight: 600 !important;
                    display: flex !important;
                    align-items: center !important;
                }
                
                .sidebar-header h2 svg {
                    width: 1rem !important;
                    height: 1rem !important;
                    margin-right: 0.375rem !important;
                    flex-shrink: 0 !important;
                }
                
                /* SEARCH BOX - Compact */
                .sidebar-header .relative {
                    margin-bottom: 0 !important;
                }
                
                .sidebar-header input {
                    padding: 0.375rem 0.5rem 0.375rem 2rem !important;
                    font-size: 0.75rem !important;
                    height: 2rem !important;
                    border-radius: 1rem !important;
                }
                
                .sidebar-header svg {
                    left: 0.5rem !important;
                    top: 0.375rem !important;
                    width: 0.875rem !important;
                    height: 0.875rem !important;
                }
                
                /* CONVERSATION LIST - Scrollable */
                .conversation-list {
                    flex: 1 !important;
                    overflow-y: auto !important;
                    padding: 0.5rem !important;
                    background: #f8f9fa !important;
                }
                
                #conversations-container {
                    display: flex !important;
                    flex-direction: column !important;
                    gap: 0.25rem !important;
                }
                
                /* CONVERSATION ITEMS - SINGLE LINE FORCED BUT INTERACTIVE */
                .conversation-item {
                    display: flex !important;
                    align-items: center !important;
                    padding: 0.5rem !important;
                    margin: 0 !important;
                    background: white !important;
                    border-radius: 0.5rem !important;
                    border: 1px solid #e5e7eb !important;
                    cursor: pointer !important;
                    transition: all 0.15s ease !important;
                    height: 3.5rem !important; /* Fixed height to prevent multi-line */
                    max-height: 3.5rem !important;
                    overflow: hidden !important;
                    flex-shrink: 0 !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                    /* PRESERVE CLICK FUNCTIONALITY */
                    pointer-events: auto !important;
                    position: relative !important;
                    z-index: 1 !important;
                }
                
                .conversation-item:hover {
                    background: #f3f4f6 !important;
                    border-color: #d1d5db !important;
                }
                
                .conversation-item.active {
                    background: #eff6ff !important;
                    border-color: #3b82f6 !important;
                }
                
                /* FORCE HORIZONTAL LAYOUT - NO WRAPPING */
                .conversation-item > * {
                    flex-shrink: 0 !important;
                    display: flex !important;
                    align-items: center !important;
                }
                
                /* AVATAR CONTAINER - FIXED SIZE */
                .conversation-item .relative.flex-shrink-0 {
                    width: 1.5rem !important;
                    height: 1.5rem !important;
                    flex-shrink: 0 !important;
                    margin-right: 0.5rem !important;
                    position: relative !important;
                }
                
                .conversation-item .avatar {
                    width: 1.5rem !important;
                    height: 1.5rem !important;
                    font-size: 0.5rem !important;
                    line-height: 1.5rem !important;
                    border-radius: 50% !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    font-weight: 600 !important;
                    flex-shrink: 0 !important;
                    margin: 0 !important;
                }
                
                /* ONLINE INDICATOR - TINY */
                .conversation-item .absolute.-bottom-1.-right-1 {
                    width: 0.375rem !important;
                    height: 0.375rem !important;
                    bottom: -0.0625rem !important;
                    right: -0.0625rem !important;
                    position: absolute !important;
                }
                
                /* CONVERSATION INFO - FLEXIBLE BUT CONSTRAINED */
                .conversation-item .flex-1.min-w-0 {
                    flex: 1 !important;
                    min-width: 0 !important;
                    overflow: hidden !important;
                    height: 100% !important;
                    display: flex !important;
                    flex-direction: column !important;
                    justify-content: center !important;
                }
                
                /* NAME ROW - SINGLE LINE */
                .conversation-item .flex.items-center.justify-between {
                    display: flex !important;
                    align-items: center !important;
                    justify-content: space-between !important;
                    width: 100% !important;
                    margin-bottom: 0.125rem !important;
                    overflow: hidden !important;
                }
                
                .conversation-item h3 {
                    font-size: 0.6875rem !important; /* 11px */
                    font-weight: 600 !important;
                    color: black !important;
                    margin: 0 !important;
                    line-height: 1.2 !important;
                    white-space: nowrap !important;
                    overflow: hidden !important;
                    text-overflow: ellipsis !important;
                    max-width: calc(100% - 3rem) !important; /* Reserve space for timestamp */
                }
                
                .conversation-item .text-xs.text-gray-500 {
                    font-size: 0.5rem !important; /* 8px */
                    color: #6b7280 !important;
                    flex-shrink: 0 !important;
                    margin-left: 0.25rem !important;
                    white-space: nowrap !important;
                }
                
                /* MESSAGE TYPE TAG - INLINE TINY */
                .conversation-item .inline-flex.items-center.px-2.py-1.rounded-full {
                    display: inline-flex !important;
                    padding: 0.0625rem 0.25rem !important; /* Ultra tiny */
                    font-size: 0.5rem !important; /* 8px */
                    line-height: 1 !important;
                    border-radius: 0.5rem !important;
                    margin-right: 0.25rem !important;
                    margin-bottom: 0 !important;
                    vertical-align: middle !important;
                    max-width: 4rem !important;
                    overflow: hidden !important;
                    text-overflow: ellipsis !important;
                    white-space: nowrap !important;
                }
                
                /* LAST MESSAGE - SINGLE LINE ONLY */
                .conversation-item p {
                    font-size: 0.5625rem !important; /* 9px */
                    color: #6b7280 !important;
                    margin: 0 !important;
                    line-height: 1.2 !important;
                    white-space: nowrap !important;
                    overflow: hidden !important;
                    text-overflow: ellipsis !important;
                    max-width: 100% !important;
                }
                
                .conversation-item p .font-medium.text-black {
                    color: black !important;
                    font-weight: 500 !important;
                }
                
                /* FORCE NO EXTRA SPACING */
                .conversation-item .flex.items-center.space-x-3 {
                    width: 100% !important;
                    display: flex !important;
                    align-items: center !important;
                    gap: 0 !important;
                    height: 100% !important;
                    overflow: hidden !important;
                }
                
                .conversation-item .flex.items-center.space-x-3 > * + * {
                    margin-left: 0 !important;
                }
                
                /* REMOVE ANY POTENTIAL LINE BREAKS */
                .conversation-item * {
                    white-space: nowrap !important;
                    overflow: hidden !important;
                }
                
                /* CHAT AREA WHEN ACTIVE */
                .messages-container.chat-active .chat-header {
                    flex-shrink: 0 !important;
                    padding: 0.5rem 0.75rem !important;
                    background: white !important;
                    border-bottom: 1px solid #e5e7eb !important;
                    display: flex !important;
                    align-items: center !important;
                    min-height: 3rem !important;
                }
                
                .chat-header .flex.items-center.space-x-4 {
                    width: 100% !important;
                    gap: 0.5rem !important;
                }
                
                .chat-header .flex.items-center.space-x-4 > * + * {
                    margin-left: 0 !important;
                }
                
                /* MOBILE BACK BUTTON */
                .mobile-back-button {
                    padding: 0.375rem !important;
                    margin-right: 0.25rem !important;
                    border-radius: 0.375rem !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                }
                
                .mobile-back-button svg {
                    width: 1rem !important;
                    height: 1rem !important;
                }
                
                /* CHAT AVATAR - OVERFLOW HIDDEN TO HIDE EXTRA ICONS */
                .chat-header .relative {
                    position: relative !important;
                    width: 1.75rem !important;
                    height: 1.75rem !important;
                    overflow: hidden !important;
                    flex-shrink: 0 !important;
                }
                
                .chat-header #chat-avatar {
                    width: 1.75rem !important;
                    height: 1.75rem !important;
                    font-size: 0.625rem !important;
                    position: relative !important;
                    z-index: 1 !important;
                }
                
                /* HIDE ALL ABSOLUTE POSITIONED ELEMENTS (ONLINE DOTS) */
                .chat-header .absolute.-bottom-0\\.5.-right-0\\.5,
                .chat-header .absolute {
                    display: none !important;
                    visibility: hidden !important;
                    opacity: 0 !important;
                }
                
                /* HIDE STATUS DOT */
                .chat-header #chat-status .w-2.h-2 {
                    display: none !important;
                    visibility: hidden !important;
                    width: 0 !important;
                    height: 0 !important;
                }
                
                /* CHAT INFO */
                .chat-header .flex-1 {
                    flex: 1 !important;
                    min-width: 0 !important;
                }
                
                .chat-header #chat-name {
                    font-size: 0.875rem !important;
                    font-weight: 600 !important;
                    color: black !important;
                    margin: 0 !important;
                    line-height: 1.2 !important;
                    white-space: nowrap !important;
                    overflow: hidden !important;
                    text-overflow: ellipsis !important;
                }
                
                .chat-header #chat-status {
                    font-size: 0.625rem !important;
                    color: #6b7280 !important;
                    margin: 0 !important;
                    line-height: 1.2 !important;
                    display: flex !important;
                    align-items: center !important;
                }
                
                .chat-header #chat-status .w-2.h-2 {
                    width: 0.375rem !important;
                    height: 0.375rem !important;
                    margin-right: 0.25rem !important;
                }
                
                /* ACTION BUTTONS - Compact */
                .chat-header .flex-shrink-0 {
                    display: flex !important;
                    gap: 0.25rem !important;
                }
                
                #reveal-identity-btn, #schedule-meeting-btn {
                    padding: 0.375rem 0.5rem !important;
                    font-size: 0.625rem !important;
                    line-height: 1 !important;
                    border-radius: 0.375rem !important;
                    display: flex !important;
                    align-items: center !important;
                    gap: 0.25rem !important;
                }
                
                #reveal-identity-btn svg, #schedule-meeting-btn svg {
                    width: 0.75rem !important;
                    height: 0.75rem !important;
                    flex-shrink: 0 !important;
                }
                
                .hidden.sm\\:inline {
                    display: none !important;
                }
                
                /* MESSAGES LIST - Scrollable area */
                .messages-list {
                    flex: 1 !important;
                    overflow-y: auto !important;
                    padding: 0.5rem !important;
                    background: #f8f9fa !important;
                    min-height: 0 !important;
                }
                
                #messages-list {
                    display: flex !important;
                    flex-direction: column !important;
                    gap: 0.375rem !important;
                }
                
                /* MESSAGE BUBBLES - NO INDIVIDUAL SCROLLING */
                .message-bubble {
                    padding: 0.375rem 0.5rem !important;
                    font-size: 0.75rem !important;
                    line-height: 1.3 !important;
                    border-radius: 1rem !important;
                    max-width: 100% !important;
                    word-wrap: break-word !important;
                    overflow-wrap: break-word !important;
                    overflow: hidden !important;
                    overflow-x: hidden !important;
                    overflow-y: hidden !important;
                }
                
                /* FORCE NO SCROLLING ON ANY MESSAGE ELEMENTS */
                .message-bubble *,
                .message-bubble p,
                .message-bubble div,
                .message-bubble span {
                    overflow: hidden !important;
                    overflow-x: hidden !important;
                    overflow-y: hidden !important;
                }
                
                /* MESSAGE CONTAINERS - NO SCROLLING */
                .flex.justify-end,
                .flex.justify-start,
                .max-w-\\[85\\%\\],
                .min-w-\\[60px\\],
                .group {
                    overflow: hidden !important;
                    overflow-x: hidden !important;
                    overflow-y: hidden !important;
                }
                
                /* MESSAGE TEXT - FORCE NO SCROLL */
                .message-bubble .text-sm {
                    overflow: hidden !important;
                    text-overflow: ellipsis !important;
                    white-space: pre-wrap !important;
                    word-break: break-word !important;
                    overflow-wrap: break-word !important;
                }
                
                /* MESSAGE INPUT AREA - PRESERVE FUNCTIONALITY */
                .message-input-container {
                    flex-shrink: 0 !important;
                    background: white !important;
                    border-top: 1px solid #e5e7eb !important;
                    padding: 0.5rem !important;
                    display: flex !important;
                    align-items: flex-end !important;
                    gap: 0.375rem !important;
                    overflow-x: hidden !important;
                    /* PRESERVE VERTICAL INTERACTION FOR INPUT RESIZE */
                    overflow-y: visible !important;
                    pointer-events: auto !important;
                    z-index: 10 !important;
                }
                
                .message-input-container .flex.items-center.space-x-3 {
                    width: 100% !important;
                    gap: 0.375rem !important;
                    align-items: flex-end !important;
                    overflow: hidden !important;
                }
                
                .message-input-container .flex.items-center.space-x-3 > * + * {
                    margin-left: 0 !important;
                }
                
                /* INPUT BUTTONS - Tiny */
                .message-input-container .btn.btn-ghost {
                    padding: 0.375rem !important;
                    width: 2rem !important;
                    height: 2rem !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    border-radius: 50% !important;
                    flex-shrink: 0 !important;
                }
                
                .message-input-container .btn.btn-ghost svg {
                    width: 0.875rem !important;
                    height: 0.875rem !important;
                }
                
                /* MESSAGE INPUT FIELD - PRESERVE FUNCTIONALITY */
                .message-input-container .flex-1 {
                    flex: 1 !important;
                    min-width: 0 !important;
                    overflow: visible !important;
                    position: relative !important;
                }
                
                .message-input-container textarea {
                    padding: 0.375rem 0.75rem !important;
                    font-size: 0.75rem !important;
                    line-height: 1.3 !important;
                    min-height: 2rem !important;
                    max-height: 3rem !important;
                    border-radius: 1rem !important;
                    resize: none !important;
                    overflow: hidden !important;
                    overflow-y: auto !important;
                    pointer-events: auto !important;
                    position: relative !important;
                    z-index: 5 !important;
                }
                
                /* SEND BUTTON - PRESERVE CLICK FUNCTIONALITY */
                .message-input-container .btn.btn-primary {
                    padding: 0.375rem !important;
                    width: 2rem !important;
                    height: 2rem !important;
                    border-radius: 50% !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    flex-shrink: 0 !important;
                    pointer-events: auto !important;
                    position: relative !important;
                    z-index: 10 !important;
                    overflow: visible !important;
                }
                
                .message-input-container .btn.btn-primary svg {
                    width: 0.875rem !important;
                    height: 0.875rem !important;
                    pointer-events: none !important;
                }
                
                /* ENSURE ALL BUTTONS ARE CLICKABLE */
                button, .btn {
                    pointer-events: auto !important;
                    position: relative !important;
                    z-index: 5 !important;
                    overflow: visible !important;
                }
                
                /* EMPTY STATE - Compact */
                #empty-state {
                    padding: 2rem 1rem !important;
                    text-align: center !important;
                }
                
                #empty-state .w-20.h-20 {
                    width: 3rem !important;
                    height: 3rem !important;
                    margin-bottom: 1rem !important;
                }
                
                #empty-state .w-10.h-10 {
                    width: 1.5rem !important;
                    height: 1.5rem !important;
                }
                
                #empty-state h3 {
                    font-size: 1.125rem !important;
                    margin-bottom: 0.5rem !important;
                }
                
                #empty-state p {
                    font-size: 0.75rem !important;
                    margin-bottom: 1rem !important;
                }
                
                #empty-state .card {
                    padding: 0.75rem !important;
                    max-width: 20rem !important;
                }
                
                #empty-state .card p {
                    font-size: 0.625rem !important;
                }
                
                /* NO CONVERSATIONS STATE */
                .conversation-list .text-center {
                    padding: 2rem 1rem !important;
                }
                
                .conversation-list .w-16.h-16 {
                    width: 2.5rem !important;
                    height: 2.5rem !important;
                    margin-bottom: 1rem !important;
                }
                
                .conversation-list .w-8.h-8 {
                    width: 1.5rem !important;
                    height: 1.5rem !important;
                }
                
                .conversation-list .text-sm {
                    font-size: 0.75rem !important;
                }
                
                .conversation-list .btn {
                    padding: 0.375rem 0.75rem !important;
                    font-size: 0.625rem !important;
                    margin-top: 0.75rem !important;
                }
                
                /* GLOBAL TEXT FIXES */
                .text-sm {
                    font-size: 0.75rem !important;
                }
                
                .text-xs {
                    font-size: 0.625rem !important;
                }
                
                .text-lg {
                    font-size: 0.875rem !important;
                }
                
                .text-xl {
                    font-size: 1rem !important;
                }
                
                .text-2xl {
                    font-size: 1.125rem !important;
                }
                
                /* SPACING FIXES */
                .space-x-3 > * + * {
                    margin-left: 0 !important;
                }
                
                .space-x-4 > * + * {
                    margin-left: 0 !important;
                }
                
                .space-y-4 > * + * {
                    margin-top: 0.375rem !important;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    bindEvents() {
        // Conversation selection
        const conversationsContainer = document.getElementById('conversations-container');
        if (conversationsContainer) {
            conversationsContainer.addEventListener('click', (e) => {
                const conversationItem = e.target.closest('.conversation-item');
                if (conversationItem) {
                    e.preventDefault();
                    const userId = parseInt(conversationItem.dataset.userId);
                    const userName = conversationItem.dataset.userName;
                    const lastSeen = conversationItem.dataset.lastSeen;
                    const messageTypeIdStr = conversationItem.dataset.messageTypeId;
                    const messageTypeId = messageTypeIdStr === 'null' || messageTypeIdStr === null || messageTypeIdStr === undefined ? null : parseInt(messageTypeIdStr);
                    
                    console.log('Selecting conversation:', {
                        userId: userId,
                        userName: userName,
                        messageTypeIdStr: messageTypeIdStr,
                        messageTypeId: messageTypeId,
                        element: conversationItem
                    });
                    
                    this.selectConversation(conversationItem, userId, userName, lastSeen, messageTypeId);
                }
            });
        }
        
        // Search functionality
        const searchInput = document.getElementById('conversation-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    this.searchConversations(e.target.value);
                }, 300);
            });
        }
        
        // Mobile back button functionality
        const backButton = document.querySelector('.mobile-back-button');
        if (backButton) {
            backButton.addEventListener('click', () => {
                this.goBackToConversationList();
            });
        }
    }
    
    setupMessageInput() {
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        
        if (!messageInput || !sendButton) return;
        
        // Auto-resize textarea
        messageInput.addEventListener('input', (e) => {
            e.target.style.height = 'auto';
            e.target.style.height = Math.min(e.target.scrollHeight, 80) + 'px';
            
            // Enable/disable send button (only if not readonly/disabled)
            if (!e.target.disabled && !e.target.readOnly) {
                sendButton.disabled = e.target.value.trim().length === 0;
            }
        });
        
        // Send on Enter
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !e.target.disabled && !e.target.readOnly) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // Send button click
        sendButton.addEventListener('click', () => {
            this.sendMessage();
        });
    }
    
    autoSelectFirstConversation() {
        // Only auto-select on desktop, not mobile (WhatsApp-like behavior)
        if (window.innerWidth > 768) {
            const firstConversation = document.querySelector('.conversation-item');
            if (firstConversation) {
                const userId = parseInt(firstConversation.dataset.userId);
                const userName = firstConversation.dataset.userName;
                const messageTypeId = firstConversation.dataset.messageTypeId === 'null' ? null : parseInt(firstConversation.dataset.messageTypeId);
                
                const lastSeen = firstConversation.dataset.lastSeen;
                this.selectConversation(firstConversation, userId, userName, lastSeen, messageTypeId);
            }
        }
    }
    
    selectConversation(conversationElement, userId, userName, lastSeen, messageTypeId = null) {
        // Remove active class from all conversations
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Add active class to selected conversation
        conversationElement.classList.add('active');
        
        // Update chat header
        this.updateChatHeader(userName, lastSeen, messageTypeId);
        
        // Show chat interface
        this.showChatInterface();
        
        // On mobile, hide sidebar and show chat area (WhatsApp style)
        if (window.innerWidth <= 768) {
            document.querySelector('.messages-container').classList.add('chat-active');
        }
        
        // Load messages
        this.currentUserId = userId;
        this.currentMessageTypeId = messageTypeId;
        
        console.log('Set current context in selectConversation:', {
            userId: this.currentUserId,
            messageTypeId: this.currentMessageTypeId
        });
        
        // Set global variable for reveal identity function
        currentChatUserId = userId;
        
        // Show reveal identity button (async)
        this.showRevealIdentityButton();
        
        // Check chat block status for this user
        checkChatBlockStatus(userId);
        
        this.loadMessages(userId, messageTypeId);
        
        // Start polling for new messages
        this.startMessagePolling();
    }
    
    goBackToConversationList() {
        // Remove chat-active class to show sidebar on mobile
        document.querySelector('.messages-container').classList.remove('chat-active');
        
        // Stop message polling
        this.stopMessagePolling();
        this.clearLastSeenInterval();
        
        // Hide reveal identity button
        const revealButton = document.getElementById('reveal-identity-btn');
        if (revealButton) {
            revealButton.classList.add('hidden');
        }
        
        // Clear current selection
        this.currentUserId = null;
        this.currentMessageTypeId = null;
        currentChatUserId = null;
    }
    
    updateChatHeader(userName, lastSeen, messageTypeId) {
        const chatName = document.getElementById('chat-name');
        const chatAvatar = document.getElementById('chat-avatar');
        const lastSeenTime = document.getElementById('last-seen-time');
        
        if (chatName) {
            chatName.textContent = userName;
        }
        
        if (lastSeenTime) {
            // Store the user ID to fetch fresh last seen data
            if (this.currentUserId) {
                this.updateLastSeenTime(this.currentUserId);
                // Set up interval to update last seen time every minute
                this.clearLastSeenInterval();
                this.lastSeenInterval = setInterval(() => {
                    this.updateLastSeenTime(this.currentUserId);
                }, 60000); // Update every minute
            } else {
                lastSeenTime.textContent = lastSeen || 'Never';
            }
        }
        
        if (chatAvatar) {
            chatAvatar.textContent = userName.charAt(0).toUpperCase();
            
            // Apply avatar color logic with multi-colored borders
            const userId = this.currentUserId;
            let bgClass = 'avatar-white';
            
            if (userId % 6 === 0) {
                bgClass = 'avatar-gray-1';  // Red border
            } else if ((userId + 1) % 6 === 0) {
                bgClass = 'avatar-gray-2';  // Blue border
            } else if ((userId + 2) % 6 === 0) {
                bgClass = 'avatar-gray-3';  // Green border
            } else if ((userId + 3) % 6 === 0) {
                bgClass = 'avatar-white';   // Orange border
            } else if ((userId + 4) % 6 === 0) {
                bgClass = 'avatar-purple'; // Purple border
            } else {
                bgClass = 'avatar-teal';   // Teal border
            }
            
            chatAvatar.className = `avatar ${bgClass}`;
        }
    }
    
    showChatInterface() {
        const chatHeader = document.getElementById('chat-header');
        const messageInputArea = document.getElementById('message-input-area');
        const emptyState = document.getElementById('empty-state');
        
        if (chatHeader) chatHeader.classList.remove('hidden');
        if (messageInputArea) messageInputArea.classList.remove('hidden');
        if (emptyState) emptyState.classList.add('hidden');
    }
    
    async showRevealIdentityButton() {
        const revealButton = document.getElementById('reveal-identity-btn');
        if (!revealButton || !this.currentUserId) return;
        
        try {
            // Get messages to check who sent the first message
            let url = `/messages/api/messages/${this.currentUserId}/`;
            if (this.currentMessageTypeId !== null && this.currentMessageTypeId !== undefined) {
                url += `?message_type_id=${this.currentMessageTypeId}`;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.messages && data.messages.length > 0) {
                // Get the first message in the conversation
                const firstMessage = data.messages[0];
                
                // Only show reveal button if current user received the first message
                // (i.e., the other user sent the first message)
                if (firstMessage.receiver_id == {{ user.id }}) {
                    revealButton.classList.remove('hidden');
                } else {
                    revealButton.classList.add('hidden');
                }
            } else {
                // No messages, hide the button
                revealButton.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error checking first message:', error);
            revealButton.classList.add('hidden');
        }
    }
    
    async loadMessages(userId, messageTypeId = null) {
        if (this.isLoading) return;
        
        this.isLoading = true;
        const messagesList = document.getElementById('messages-list');
        
        console.log('Loading messages for:', {
            userId: userId,
            messageTypeId: messageTypeId,
            currentUserId: this.currentUserId,
            currentMessageTypeId: this.currentMessageTypeId
        });
        
        try {
            let url = `/messages/api/messages/${userId}/`;
            if (messageTypeId !== null && messageTypeId !== undefined && messageTypeId !== 'null') {
                url += `?message_type_id=${messageTypeId}`;
            }
            
            console.log('Loading messages from URL:', url);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.messages) {
                // Clear existing messages
                if (messagesList) {
                    messagesList.innerHTML = '';
                    
                    // Add messages
                    data.messages.forEach(message => {
                        const messageElement = this.createMessageElement(message);
                        messagesList.appendChild(messageElement);
                    });
                    
                    this.lastMessageCount = data.messages.length;
                    this.scrollToBottom();
                }
                
                // Re-enable message input in case it was disabled
                this.enableMessageInput();
            } else if (data.blocked) {
                // Handle blocked chat
                if (messagesList) {
                    messagesList.innerHTML = `
                        <div class="flex items-center justify-center h-64">
                            <div class="text-center p-6 bg-red-50 border border-red-200 rounded-lg max-w-md">
                                <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <h3 class="text-lg font-semibold text-red-800 mb-2">Chat Blocked</h3>
                                <p class="text-red-600 text-sm">This chat is currently blocked due to a report. Please contact administrators if you believe this is an error.</p>
                            </div>
                        </div>
                    `;
                }
                
                // Disable message input
                this.disableMessageInput();
            }
        } catch (error) {
            console.error('Error loading messages:', error);
        } finally {
            this.isLoading = false;
        }
    }
    
    createMessageElement(message) {
        const messageDiv = document.createElement('div');
        const isOwnMessage = message.sender_id == {{ user.id }};
        
        messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-2 message-enter w-full`;
        
        const timestamp = this.formatTime(message.timestamp);
        const messageContent = this.escapeHtml(message.content.trim());
        
        messageDiv.innerHTML = `
            <div class="max-w-[85%] min-w-[60px] group flex-shrink-0">
                <div class="message-bubble ${isOwnMessage ? 'message-sent' : 'message-received'}">
                    <p class="text-sm m-0 p-0" style="line-height: 1.25; word-break: break-word; overflow-wrap: break-word;">${messageContent}</p>
                </div>
                <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mt-0.5">
                    <span class="text-xs text-gray-500 px-2 opacity-70 group-hover:opacity-100 transition-opacity">
                        ${timestamp}
                    </span>
                </div>
            </div>
        `;
        
        return messageDiv;
    }
    
    async sendMessage() {
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        
        if (!messageInput || !sendButton) return;
        
        // Check if user is verified (check if input is disabled)
        if (messageInput.disabled || messageInput.readOnly) {
            window.location.href = '{% url "profiles:referrals" %}';
            return;
        }
        
        const messageText = messageInput.value.trim();
        
        if (!messageText || !this.currentUserId || this.isLoading) {
            return;
        }
        
        // Disable send button and show loading state
        sendButton.disabled = true;
        const originalButtonContent = sendButton.innerHTML;
        sendButton.innerHTML = `
            <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        `;
        
        try {
            const messageData = {
                'receiver_id': this.currentUserId,
                'content': messageText
            };
            
            if (this.currentMessageTypeId && this.currentMessageTypeId !== 'null' && this.currentMessageTypeId !== null) {
                messageData.message_type_id = this.currentMessageTypeId;
            }
            
            console.log('Sending message with data:', messageData);
            console.log('Current context:', {
                userId: this.currentUserId,
                messageTypeId: this.currentMessageTypeId
            });
            
            const response = await fetch('/messages/api/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify(messageData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // Reload messages
                await this.loadMessages(this.currentUserId, this.currentMessageTypeId);
                
                // Update conversation preview
                this.updateConversationPreview(messageText);
            } else {
                this.showError('Error sending message: ' + data.error);
            }
        } catch (error) {
            console.error('Error sending message:', error);
            this.showError('Failed to send message');
        } finally {
            // Restore send button
            sendButton.innerHTML = originalButtonContent;
            sendButton.disabled = messageInput.value.trim().length === 0;
        }
    }
    
    updateConversationPreview(messageText) {
        const currentConversation = document.querySelector('.conversation-item.active');
        if (currentConversation) {
            const previewElement = currentConversation.querySelector('p');
            if (previewElement) {
                previewElement.innerHTML = `<span class="text-black font-medium">You:</span> ${messageText.substring(0, 30)}${messageText.length > 30 ? '...' : ''}`;
            }
        }
    }
    
    startMessagePolling() {
        this.stopMessagePolling();
        
        this.messagePolling = setInterval(async () => {
            if (this.currentUserId && !this.isLoading) {
                try {
                    let url = `/messages/api/messages/${this.currentUserId}/`;
                    if (this.currentMessageTypeId !== null && this.currentMessageTypeId !== undefined) {
                        url += `?message_type_id=${this.currentMessageTypeId}`;
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.success && data.messages && data.messages.length > this.lastMessageCount) {
                        await this.loadMessages(this.currentUserId, this.currentMessageTypeId);
                    }
                } catch (error) {
                    console.error('Error polling messages:', error);
                }
            }
        }, 5000);
    }
    
    stopMessagePolling() {
        if (this.messagePolling) {
            clearInterval(this.messagePolling);
            this.messagePolling = null;
        }
    }
    
    clearLastSeenInterval() {
        if (this.lastSeenInterval) {
            clearInterval(this.lastSeenInterval);
            this.lastSeenInterval = null;
        }
    }
    
    async updateLastSeenTime(userId) {
        try {
            // Fetch fresh user data to get current last_login time
            const response = await fetch(`/messages/api/user-info/${userId}/`);
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.last_login) {
                    const lastSeenTime = document.getElementById('last-seen-time');
                    if (lastSeenTime) {
                        lastSeenTime.textContent = this.formatTime(data.last_login);
                    }
                }
            }
        } catch (error) {
            console.error('Error updating last seen time:', error);
        }
    }
    
    scrollToBottom() {
        const messagesContainer = document.querySelector('.messages-list');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    
    searchConversations(query) {
        const conversations = document.querySelectorAll('.conversation-item');
        
        conversations.forEach(conversation => {
            const userName = conversation.dataset.userName.toLowerCase();
            const messageContent = conversation.querySelector('p:last-child').textContent.toLowerCase();
            
            if (userName.includes(query.toLowerCase()) || messageContent.includes(query.toLowerCase())) {
                conversation.style.display = 'block';
            } else {
                conversation.style.display = 'none';
            }
        });
    }
    
    showError(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-white text-black border border-gray-300 px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
    
    formatTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInMinutes = Math.floor((now - date) / 60000);
        
        if (diffInMinutes < 1) return 'Just now';
        if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
        if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
        
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    getCSRFToken() {
        return '{{ csrf_token }}';
    }
    
    disableMessageInput() {
        // Disable the message input form
        const messageInput = document.getElementById('message-input');
        const sendButton = document.querySelector('.send-message-btn');
        const messageForm = document.getElementById('message-form');
        
        if (messageInput) {
            messageInput.disabled = true;
            messageInput.placeholder = 'This chat is blocked';
        }
        
        if (sendButton) {
            sendButton.disabled = true;
            sendButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
        
        if (messageForm) {
            messageForm.style.display = 'none';
        }
    }
    
    enableMessageInput() {
        // Re-enable the message input form
        const messageInput = document.getElementById('message-input');
        const sendButton = document.querySelector('.send-message-btn');
        const messageForm = document.getElementById('message-form');
        
        if (messageInput) {
            messageInput.disabled = false;
            messageInput.placeholder = 'Type your message...';
        }
        
        if (sendButton) {
            sendButton.disabled = false;
            sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        if (messageForm) {
            messageForm.style.display = 'flex';
        }
    }
    
    cleanup() {
        this.stopMessagePolling();
        this.clearLastSeenInterval();
        if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
        }
    }
}

// Initialize the messaging app when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.messagingApp = new MessagingApp();
});

// Cleanup when page unloads
window.addEventListener('beforeunload', function() {
    if (window.messagingApp) {
        window.messagingApp.cleanup();
    }
    // Remove messages-page class when leaving
    document.body.classList.remove('messages-page');
});

// Also remove class when page visibility changes (back button, etc.)
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden') {
        document.body.classList.remove('messages-page');
    }
});

// Schedule meeting function
function scheduleMeeting() {
    // Open Google Meet in a new tab/window
    window.open('https://meet.google.com/', '_blank');
}

// Global variable to track current chat user ID
let currentChatUserId = null;

// Reveal identity function
function revealIdentity() {
    if (!currentChatUserId) {
        alert('No conversation selected');
        return;
    }
    
    if (confirm('Are you sure you want to reveal your real identity to this person for this conversation? This action cannot be undone.')) {
        // Get the current message type from the messaging app
        const messageTypeId = window.messagingApp ? window.messagingApp.currentMessageTypeId : null;
        
        fetch(`/messages/api/reveal-identity/${currentChatUserId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'message_type_id': messageTypeId
            }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Hide the reveal identity button since identity is now revealed
                document.getElementById('reveal-identity-btn').classList.add('hidden');
                
                // Reload messages to reflect the identity change
                if (window.messagingApp && window.messagingApp.currentUserId) {
                    window.messagingApp.loadMessages(window.messagingApp.currentUserId, window.messagingApp.currentMessageTypeId);
                }
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while revealing identity');
        });
    }
}

// Handle Report or Unblock
function handleReportOrUnblock() {
    if (!window.messagingApp || !window.messagingApp.currentUserId) return;
    
    const reportBtn = document.getElementById('report-user-btn');
    const isBlocked = reportBtn.dataset.blocked === 'true';
    
    if (isBlocked) {
        // Unblock the user
        unblockUser(window.messagingApp.currentUserId);
    } else {
        // Open report modal
        openReportModal();
    }
}

// Unblock User
function unblockUser(userId) {
    if (!confirm('Are you sure you want to unblock this user? They will be able to message you again.')) return;
    
    fetch(`/messages/api/unblock/${userId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('User has been unblocked successfully!', 'success');
            // Update button state
            const reportBtn = document.getElementById('report-user-btn');
            const reportBtnText = document.getElementById('report-btn-text');
            const reportIcon = document.getElementById('report-icon');
            
            reportBtn.dataset.blocked = 'false';
            reportBtnText.textContent = 'Report';
            reportBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            reportBtn.classList.add('bg-black', 'hover:bg-gray-800');
            
            // Change icon back to warning
            reportIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>';
            
            // Reload messages to reflect the change
            if (window.messagingApp && window.messagingApp.currentUserId) {
                window.messagingApp.loadMessages(window.messagingApp.currentUserId, window.messagingApp.currentMessageTypeId);
            }
        } else {
            showNotification('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while unblocking the user', 'error');
    });
}

// Check if chat is blocked
function checkChatBlockStatus(userId) {
    // This function will be called when a conversation is loaded
    // to update the report/unblock button state
    fetch(`/messages/api/user-info/${userId}/`)
    .then(response => response.json())
    .then(data => {
        const reportBtn = document.getElementById('report-user-btn');
        const reportBtnText = document.getElementById('report-btn-text');
        const reportIcon = document.getElementById('report-icon');
        
        if (data.is_chat_blocked !== undefined && data.is_chat_blocked) {
            // Chat is blocked, show unblock button
            reportBtn.dataset.blocked = 'true';
            reportBtnText.textContent = 'Unblock';
            reportBtn.classList.remove('bg-black', 'hover:bg-gray-800');
            reportBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            
            // Change icon to unlock
            reportIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>';
        } else {
            // Chat is not blocked, show report button
            reportBtn.dataset.blocked = 'false';
            reportBtnText.textContent = 'Report';
            reportBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            reportBtn.classList.add('bg-black', 'hover:bg-gray-800');
            
            // Change icon to warning
            reportIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>';
        }
    })
    .catch(error => {
        console.error('Error checking chat block status:', error);
    });
}

// Open Report Modal
function openReportModal() {
    if (!window.messagingApp || !window.messagingApp.currentUserId) return;
    
    const modal = document.getElementById('reportModal');
    modal.classList.remove('hidden');
}

// Close Report Modal
function closeReportModal() {
    const modal = document.getElementById('reportModal');
    modal.classList.add('hidden');
    document.getElementById('report-form').reset();
}


// Submit Report
function submitReport() {
    if (!window.messagingApp || !window.messagingApp.currentUserId) return;
    
    const userId = window.messagingApp.currentUserId;
    const reportType = document.getElementById('report-type').value;
    const note = document.getElementById('report-note').value;
    
    if (!reportType) {
        alert('Please select a report type');
        return;
    }
    
    if (!note.trim()) {
        alert('Please provide details about your report');
        return;
    }
    
    // Get CSRF token from meta tag or cookie
    let csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (csrfToken) {
        csrfToken = csrfToken.getAttribute('content');
    } else {
        // Fallback: get from cookie
        csrfToken = getCookie('csrftoken');
    }
    
    fetch(`/messages/api/report/${userId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            report_type: reportType,
            note: note
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Report submitted successfully. This user has also been blocked. Administrators will review your report.', 'success');
            closeReportModal();
            // Update the button state without full page reload
            checkChatBlockStatus(window.messagingApp.currentUserId);
            // Reload messages to reflect the change
            if (window.messagingApp && window.messagingApp.currentUserId) {
                window.messagingApp.loadMessages(window.messagingApp.currentUserId, window.messagingApp.currentMessageTypeId);
            }
        } else {
            showNotification('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while submitting the report', 'error');
    });
}

// Show notification function
function showNotification(message, type = 'success') {
    // Remove existing notification if any
    const existingNotification = document.getElementById('notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.id = 'notification';
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
    
    // Set colors based on type
    if (type === 'success') {
        notification.className += ' bg-green-500 text-white';
    } else if (type === 'error') {
        notification.className += ' bg-red-500 text-white';
    } else {
        notification.className += ' bg-blue-500 text-white';
    }
    
    notification.innerHTML = `
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${type === 'success' ? 
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>' :
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'
                }
            </svg>
            <span>${message}</span>
        </div>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 4000);
}

// Helper function to get cookie value
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>


<!-- Report Modal -->
<div id="reportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold mb-4">Report User</h3>
        
        <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-sm text-yellow-800">
                <strong>Note:</strong> This report will be reviewed by administrators. 
                Use the Block button if you just want to prevent messages from this user.
            </p>
        </div>
        
        <form id="report-form" onsubmit="event.preventDefault(); submitReport();">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                <select id="report-type" class="input w-full" required>
                    <option value="">Select a reason</option>
                    <option value="spam">Spam</option>
                    <option value="harassment">Harassment</option>
                    <option value="inappropriate">Inappropriate Content</option>
                    <option value="fake">Fake Account</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Additional Details</label>
                <textarea id="report-note" class="input w-full" rows="4" required 
                          placeholder="Please provide more details about your report..."></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeReportModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Submit Report
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}