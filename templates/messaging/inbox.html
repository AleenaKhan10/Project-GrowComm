{% extends 'base.html' %}

{% block title %}Messages - GrowCommunity{% endblock %}

{% block content %}
<!-- Fixed Layout Container with proper height calculation -->
<div class="fixed inset-0 top-[88px] bg-black overflow-hidden">
    <div class="w-full h-full grid grid-cols-1 md:grid-cols-[380px_1fr]">
        <!-- Left sidebar - Conversations list -->
        <div class="sidebar w-full bg-card border-r border-gray-700 lime-border flex flex-col shadow-lg overflow-hidden">
        <!-- Header - Fixed height -->
        <div class="h-20 px-6 py-4 border-b border-gray-700 bg-black flex-shrink-0">
            <h2 class="text-xl font-light text-white mb-3 flex items-center">
                <svg class="w-6 h-6 mr-3 text-lime" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.966 8.966 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"/>
                </svg>
                Messages
            </h2>
            <div class="relative">
                <input 
                    id="conversation-search"
                    type="text" 
                    placeholder="Search by name or message..." 
                    class="w-full pl-10 pr-8 py-2 border border-gray-700 lime-border rounded-lg text-sm bg-gray-900 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-lime focus:ring-opacity-50 focus:border-lime transition-all duration-200"
                >
                <svg class="absolute left-3 top-2.5 w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <!-- Clear search button -->
                <button id="clear-search" class="absolute right-2 top-2.5 w-4 h-4 text-gray-500 hover:text-gray-300 hidden" title="Clear search">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- New Message Button -->
        <div class="px-6 py-3 border-b border-gray-800">
            <button class="w-full flex items-center justify-center px-4 py-2 bg-lime text-black rounded-lg hover:bg-lime-light transition-all duration-200 font-medium text-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                New Message
            </button>
        </div>
        
        <!-- Conversations list - Scrollable area -->
        <div class="flex-1 overflow-y-auto">
            {% if conversations %}
                <div id="conversations-container">
                    {% for conversation in conversations %}
                        <div class="conversation-item group relative p-4 border-b border-gray-800 hover:bg-gray-800 cursor-pointer transition-all duration-200 ease-in-out {% if forloop.first %}bg-zinc-900 border-l-4 border-lime{% endif %}" 
                             data-user-id="{{ conversation.other_user.id }}"
                             data-user-name="{{ conversation.other_user.profile.display_name|default:conversation.other_user.username|escapejs }}"
                             data-message-type-id="{% if conversation.message_type %}{{ conversation.message_type.id }}{% else %}null{% endif %}"
                             data-message-type-name="{% if conversation.message_type %}{{ conversation.message_type.name|escapejs }}{% else %}General{% endif %}">
                            <div class="flex items-center space-x-3">
                                <!-- Avatar -->
                                <div class="relative flex-shrink-0">
                                    {% if conversation.other_user.profile.profile_picture %}
                                        <img src="{{ conversation.other_user.profile.profile_picture.url }}" 
                                             alt="{{ conversation.other_user.profile.display_name|default:conversation.other_user.username }}" 
                                             class="w-14 h-14 rounded-full object-cover border-2 border-gray-600 group-hover:border-lime transition-colors">
                                    {% else %}
                                        {% with user_id=conversation.other_user.id %}
                                        {% if user_id|divisibleby:6 %}
                                            <div class="w-14 h-14 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-base border-2 border-gray-600 group-hover:border-lime transition-colors">
                                        {% elif user_id|add:1|divisibleby:6 %}
                                            <div class="w-14 h-14 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold text-base border-2 border-gray-600 group-hover:border-lime transition-colors">
                                        {% elif user_id|add:2|divisibleby:6 %}
                                            <div class="w-14 h-14 rounded-full bg-green-500 flex items-center justify-center text-white font-bold text-base border-2 border-gray-600 group-hover:border-lime transition-colors">
                                        {% elif user_id|add:3|divisibleby:6 %}
                                            <div class="w-14 h-14 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-base border-2 border-gray-600 group-hover:border-lime transition-colors">
                                        {% elif user_id|add:4|divisibleby:6 %}
                                            <div class="w-14 h-14 rounded-full bg-pink-500 flex items-center justify-center text-white font-bold text-base border-2 border-gray-600 group-hover:border-lime transition-colors">
                                        {% else %}
                                            <div class="w-14 h-14 rounded-full bg-lime flex items-center justify-center text-black font-bold text-base border-2 border-gray-600 group-hover:border-lime transition-colors">
                                        {% endif %}
                                                {{ conversation.other_user.first_name|first|default:conversation.other_user.username|first|upper }}
                                            </div>
                                        {% endwith %}
                                    {% endif %}
                                    <!-- Online status indicator -->
                                    <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 border-2 border-black rounded-full shadow-lg"></div>
                                </div>
                                
                                <!-- Conversation info -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-1">
                                        <h3 class="text-sm font-semibold text-white truncate group-hover:text-lime transition-colors {% if forloop.first %}font-bold{% endif %}">
                                            {{ conversation.other_user.profile.display_name|default:conversation.other_user.username }}
                                        </h3>
                                        {% if conversation.latest_message %}
                                            <span class="text-xs text-gray-500 font-medium">
                                                {{ conversation.latest_message.timestamp|timesince }} ago
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2 pr-2">
                                            <p class="text-sm text-gray-400 truncate flex-1">
                                                {% if conversation.latest_message %}
                                                    {% if conversation.latest_message.sender == user %}
                                                        <span class="text-lime font-medium">You:</span> {{ conversation.latest_message.content|truncatewords:4 }}
                                                    {% else %}
                                                        {{ conversation.latest_message.content|truncatewords:5 }}
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-lime font-medium italic">Start a conversation</span>
                                                {% endif %}
                                            </p>
                                            {% if conversation.message_type %}
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-700 text-gray-300 h-6">
                                                    {{ conversation.message_type.name }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <!-- Unread count -->
                                        {% if conversation.unread_count > 0 %}
                                            <div class="bg-lime text-black rounded-full px-2.5 py-1 text-xs font-bold shadow-sm min-w-[20px] text-center">
                                                {{ conversation.unread_count }}
                                            </div>
                                        {% else %}
                                            <div class="w-2 h-2 bg-green-500 rounded-full opacity-80"></div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <!-- Hover effect overlay -->
                            <div class="absolute inset-0 bg-gradient-to-r from-lime/5 to-lime/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-l-lg"></div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="flex flex-col items-center justify-center p-8 text-center animate-fade-in">
                    <div class="w-20 h-20 bg-gradient-to-br from-gray-700 to-gray-600 rounded-full flex items-center justify-center mb-6">
                        <svg class="w-10 h-10 text-lime" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.966 8.966 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">No conversations yet</h3>
                    <p class="text-sm text-gray-300 mb-6 max-w-xs">Connect with community members and start meaningful conversations.</p>
                    <a href="{% url 'communities:user_list' %}" class="inline-flex items-center px-6 py-3 bg-lime text-black text-sm font-semibold rounded-lg hover:bg-lime-light transform hover:scale-105 transition-all duration-200 shadow-lg hover:shadow-xl lime-glow">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 919.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Browse Community
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
        <!-- Right side - Chat area -->
        <div class="hidden md:flex flex-col bg-card shadow-lg border-l border-gray-700 h-full" id="chat-area">
            <!-- Chat header - Fixed height -->
            <div id="chat-header" class="h-20 px-6 py-4 bg-black border-b border-gray-700 lime-border hidden shadow-sm flex-shrink-0 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <!-- Mobile back button -->
                    <button class="mobile-back-button p-2 text-gray-400 hover:text-lime rounded-lg hover:bg-gray-800 transition-all duration-200" title="Back to conversations">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <div class="relative">
                        <div id="chat-avatar" class="w-12 h-12 rounded-full bg-lime flex items-center justify-center text-black font-bold text-lg shadow-lg lime-glow">
                            A
                        </div>
                        <div class="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-400 border-2 border-white rounded-full shadow-sm"></div>
                    </div>
                    <div>
                        <h3 id="chat-name" class="text-lg font-semibold text-white leading-tight">Select a conversation</h3>
                        <p class="text-sm text-green-600 font-medium flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                            Online
                        </p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="p-3 text-gray-400 hover:text-lime rounded-full hover:bg-gray-800 transition-all duration-200 group" title="Voice Call">
                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                    </button>
                    <button class="p-3 text-gray-400 hover:text-lime rounded-full hover:bg-gray-800 transition-all duration-200 group" title="Video Call">
                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </button>
                    <button class="p-3 text-gray-400 hover:text-lime rounded-full hover:bg-gray-800 transition-all duration-200 group" title="More Options">
                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                        </svg>
                    </button>
                </div>
            
            <!-- Messages area - Scrollable -->
            <div id="messages-container" class="flex-1 overflow-y-auto px-6 py-4 bg-black">
                <div id="messages-list" class="space-y-4 max-w-4xl mx-auto">
                    <!-- Messages will be loaded here -->
                </div>
            
                <!-- Default state -->
                <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center animate-fade-in">
                <div class="relative">
                    <!-- Main icon -->
                    <div class="relative w-24 h-24 bg-lime rounded-full flex items-center justify-center mb-8 shadow-lg lime-glow">
                        <svg class="w-12 h-12 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.966 8.966 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"/>
                        </svg>
                    </div>
                </div>
                <h3 class="text-2xl font-bold text-white mb-3">Welcome to Messages</h3>
                <p class="text-gray-300 mb-8 max-w-md leading-relaxed">Select a conversation from the sidebar to start messaging with community members</p>
                
                <!-- Tip card -->
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-700 max-w-md">
                    <p class="text-gray-400 text-sm leading-relaxed">Start a conversation by selecting someone from the sidebar or use the "New Message" button to find community members.</p>
                </div>
                </div>
            </div>
        
            <!-- Message input - Fixed at bottom -->
            <div id="message-input-area" class="h-20 px-6 py-3 bg-black border-t border-gray-700 shadow-lg hidden flex-shrink-0">
                <div class="flex items-center space-x-3 w-full">
                <!-- Attachment button -->
                <button class="p-3 text-gray-400 hover:text-lime rounded-full hover:bg-gray-800 transition-all duration-200 group" title="Attach file">
                    <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                    </svg>
                </button>
                
                <!-- Message input container -->
                <div class="flex-1 relative">
                    <div class="bg-gray-900 rounded-full border border-gray-600 hover:border-lime transition-all duration-200 focus-within:ring-2 focus-within:ring-lime focus-within:border-lime">
                        <textarea 
                            id="message-input" 
                            class="w-full px-4 py-3 bg-transparent border-0 rounded-full resize-none focus:outline-none placeholder-gray-400 text-white max-h-20 min-h-[44px]" 
                            rows="1" 
                            placeholder="Type your message..."
                        ></textarea>
                    </div>
                </div>
                
                <!-- Emoji button -->
                <button class="p-3 text-gray-500 hover:text-lime rounded-full hover:bg-gray-800 transition-all duration-200 group" title="Add emoji">
                    <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
                
                <!-- Send button -->
                <button 
                    id="send-button" 
                    class="p-3 bg-lime text-black rounded-full hover:bg-lime-light transform hover:scale-105 transition-all duration-200 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none lime-glow"
                    title="Send message"
                    disabled
                >
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                    </svg>
                </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class MessagingApp {
    constructor() {
        this.currentUserId = null;
        this.currentUserName = '';
        this.isLoading = false;
        this.messagePolling = null;
        this.searchTimeout = null;
        this.lastMessageCount = 0;
        
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.setupSearch();
        this.setupMessageInput();
        this.autoSelectFirstConversation();
        
        // Add some CSS animations that might be missing
        this.addCustomStyles();
    }
    
    addCustomStyles() {
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes slideIn {
                from { opacity: 0; transform: translateX(20px); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            @keyframes slideInLeft {
                from { opacity: 0; transform: translateX(-20px); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            .animate-fade-in {
                animation: fadeIn 0.3s ease-out;
            }
            
            .animate-slide-in {
                animation: slideIn 0.3s ease-out;
            }
            
            .animate-slide-in-left {
                animation: slideInLeft 0.3s ease-out;
            }
            
            .message-enter {
                animation: slideIn 0.3s ease-out;
            }
            
            /* Custom scrollbar for conversations and messages */
            .sidebar::-webkit-scrollbar,
            #messages-container::-webkit-scrollbar {
                width: 6px;
            }
            
            .sidebar::-webkit-scrollbar-track,
            #messages-container::-webkit-scrollbar-track {
                background: #1a1a1a;
            }
            
            .sidebar::-webkit-scrollbar-thumb,
            #messages-container::-webkit-scrollbar-thumb {
                background: #404040;
                border-radius: 3px;
            }
            
            .sidebar::-webkit-scrollbar-thumb:hover,
            #messages-container::-webkit-scrollbar-thumb:hover {
                background: #606060;
            }
            
            /* Critical structural fixes */
            body {
                overflow: hidden;
            }
            
            /* Main container fixes */
            .fixed.inset-0 {
                display: block;
            }
            
            /* Grid layout enforcement */
            .grid.grid-cols-\[380px_1fr\] {
                display: grid !important;
                grid-template-columns: 380px 1fr !important;
                height: 100% !important;
            }
            
            /* Sidebar width enforcement */
            .sidebar {
                width: 380px !important;
                min-width: 380px !important;
                max-width: 380px !important;
            }
            
            /* Chat area structure */
            #chat-area {
                display: flex !important;
                flex-direction: column !important;
                height: 100% !important;
            }
            
            /* Messages container fixes */
            #messages-container {
                flex: 1 !important;
                overflow-y: auto !important;
                background: #000000 !important;
            }
            
            /* Input area positioning */
            /* Input area positioning */
            #message-input-area {
                position: relative !important;
                bottom: 0 !important;
                flex-shrink: 0 !important;
            }
            
            #message-input-area.hidden {
                display: none !important;
            }
            
            #message-input-area:not(.hidden) {
                display: flex !important;
                align-items: center !important;
            }
            
            /* Force proper proportions */
            @media (min-width: 769px) {
                .grid.grid-cols-\[380px_1fr\] {
                    grid-template-columns: 380px calc(100% - 380px) !important;
                }
            }
            
            /* Ensure chat header shows properly */
            #chat-header:not(.hidden) {
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
            }
            
            /* Fix message container background */
            #messages-container {
                background-color: #000000 !important;
            }
            
            /* Selected conversation styling */
            .conversation-item.bg-zinc-900 {
                background-color: #18181b !important;
                border-left: 4px solid #84cc16 !important;
            }
            
            /* Mobile responsiveness */
            @media (max-width: 768px) {
                .grid.grid-cols-\[380px_1fr\] {
                    grid-template-columns: 1fr !important;
                }
                
                .sidebar {
                    width: 100% !important;
                    min-width: 100% !important;
                    max-width: 100% !important;
                }
                
                .mobile-chat-open .sidebar {
                    display: none;
                }
                
                .mobile-chat-open #chat-area {
                    display: flex !important;
                }
                
                .mobile-back-button {
                    display: block;
                }
                
                /* Adjust fixed layout for mobile */
                .fixed.inset-0 {
                    top: 72px; /* Adjust for mobile nav height */
                }
            }
            
            @media (min-width: 769px) {
                .mobile-back-button {
                    display: none;
                }
                
                #chat-area {
                    display: flex !important;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    bindEvents() {
        // Conversation selection with event delegation for stability
        const conversationsContainer = document.getElementById('conversations-container');
        if (conversationsContainer) {
            conversationsContainer.addEventListener('click', (e) => {
                const conversationItem = e.target.closest('.conversation-item');
                if (conversationItem) {
                    e.preventDefault();
                    const userId = parseInt(conversationItem.dataset.userId);
                    const userName = conversationItem.dataset.userName;
                    this.selectConversation(userId, userName, conversationItem);
                }
            });
        }
        
        // Send button
        const sendButton = document.getElementById('send-button');
        if (sendButton) {
            sendButton.addEventListener('click', () => this.sendMessage());
        }
        
        // Mobile back button
        // Handle conversation clicks
        document.addEventListener('click', (e) => {
            const conversationItem = e.target.closest('.conversation-item');
            if (conversationItem) {
                const userId = parseInt(conversationItem.dataset.userId);
                const userName = conversationItem.dataset.userName;
                this.selectConversation(userId, userName, conversationItem);
            }
            
            if (e.target.closest('.mobile-back-button')) {
                this.hideMobileChat();
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            this.cleanup();
        });
    }
    
    setupMessageInput() {
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const charCount = document.getElementById('char-count');
        const charCounter = document.getElementById('char-counter');
        
        if (!messageInput || !sendButton) return;
        
        // Auto-resize textarea
        messageInput.addEventListener('input', (e) => {
            // Reset height to auto to get correct scrollHeight
            e.target.style.height = 'auto';
            // Set height based on scrollHeight, with max height
            e.target.style.height = Math.min(e.target.scrollHeight, 128) + 'px';
            
            // Update send button state
            const hasText = e.target.value.trim().length > 0;
            sendButton.disabled = !hasText;
            
            // Update character count
            if (charCount && charCounter) {
                const count = e.target.value.length;
                charCount.textContent = count;
                charCounter.classList.toggle('hidden', count === 0);
                
                // Show warning if close to limit
                charCounter.classList.toggle('text-red-500', count > 900);
                charCounter.classList.toggle('text-yellow-500', count > 800 && count <= 900);
            }
        });
        
        // Handle Enter key
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
    }
    
    setupSearch() {
        const searchInput = document.getElementById('conversation-search');
        const clearButton = document.getElementById('clear-search');
        if (!searchInput) return;
        
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            clearTimeout(this.searchTimeout);
            
            // Show/hide clear button
            if (clearButton) {
                clearButton.classList.toggle('hidden', query.length === 0);
            }
            
            this.searchTimeout = setTimeout(() => {
                this.filterConversations(query);
            }, 300);
        });
        
        // Clear search functionality
        if (clearButton) {
            clearButton.addEventListener('click', () => {
                searchInput.value = '';
                clearButton.classList.add('hidden');
                this.filterConversations('');
                searchInput.focus();
            });
        }
    }
    
    filterConversations(query) {
        const conversations = document.querySelectorAll('.conversation-item');
        const lowerQuery = query.toLowerCase();
        
        conversations.forEach(item => {
            const userName = item.dataset.userName.toLowerCase();
            const messageText = item.querySelector('p')?.textContent.toLowerCase() || '';
            
            const matches = userName.includes(lowerQuery) || messageText.includes(lowerQuery);
            item.style.display = matches ? 'block' : 'none';
        });
    }
    
    autoSelectFirstConversation() {
        // Only auto-select if there are conversations and no hash in URL
        if (!window.location.hash) {
            setTimeout(() => {
                const firstConversation = document.querySelector('.conversation-item');
                if (firstConversation) {
                    const userId = parseInt(firstConversation.dataset.userId);
                    const userName = firstConversation.dataset.userName;
                    this.selectConversation(userId, userName, firstConversation);
                }
            }, 100);
        }
    }
    
    selectConversation(userId, userName, conversationElement) {
        if (this.isLoading) return;
        
        // Extract message type information
        const messageTypeId = conversationElement?.dataset.messageTypeId;
        const messageTypeName = conversationElement?.dataset.messageTypeName || 'General';
        
        // Debug: Log conversation selection
        // console.log('Selecting conversation:', { userId, userName, messageTypeId, messageTypeName });
        
        // Check if this is the same conversation (user + message type)
        if (userId === this.currentUserId && messageTypeId === this.currentMessageTypeId) return;
        
        this.currentUserId = userId;
        this.currentUserName = userName;
        this.currentMessageTypeId = messageTypeId;
        this.currentMessageTypeName = messageTypeName;
        
        // Update UI highlighting
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('bg-zinc-900', 'border-l-4', 'border-lime');
        });
        
        if (conversationElement) {
            conversationElement.classList.add('bg-zinc-900', 'border-l-4', 'border-lime');
        }
        
        // Show chat interface with animation
        this.showChatInterface(userName, messageTypeName);
        
        // For mobile, show chat area and hide sidebar
        this.showMobileChat();
        
        // Load messages for this specific conversation (user + message type)
        this.loadMessages(userId, messageTypeId);
        
        // Start polling for new messages (optional)
        this.startMessagePolling();
    }
    
    showChatInterface(userName, messageTypeName = 'General') {
        const emptyState = document.getElementById('empty-state');
        const chatHeader = document.getElementById('chat-header');
        const messageInputArea = document.getElementById('message-input-area');
        
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        if (chatHeader && messageInputArea) {
            chatHeader.classList.remove('hidden');
            chatHeader.style.display = 'flex';
            messageInputArea.classList.remove('hidden');
            messageInputArea.style.display = 'block';
            
            // Update header content
            const chatName = document.getElementById('chat-name');
            const chatAvatar = document.getElementById('chat-avatar');
            
            if (chatName) {
                // Show username with message type - improved styling
                if (messageTypeName && messageTypeName !== 'General') {
                    chatName.innerHTML = `
                        <span class="font-semibold">${userName}</span>
                        <span class="inline-flex items-center ml-2 px-2 py-1 rounded-full text-xs font-medium bg-gray-700 text-gray-300">
                            ${messageTypeName}
                        </span>
                    `;
                } else {
                    chatName.textContent = userName;
                }
            }
            if (chatAvatar) {
                chatAvatar.textContent = userName.charAt(0).toUpperCase();
                // Apply same color logic as sidebar avatars
                const userId = this.currentUserId;
                let bgClass = 'bg-lime';
                let textClass = 'text-black';
                
                if (userId % 6 === 0) {
                    bgClass = 'bg-blue-500';
                    textClass = 'text-white';
                } else if ((userId + 1) % 6 === 0) {
                    bgClass = 'bg-purple-500';
                    textClass = 'text-white';
                } else if ((userId + 2) % 6 === 0) {
                    bgClass = 'bg-green-500';
                    textClass = 'text-white';
                } else if ((userId + 3) % 6 === 0) {
                    bgClass = 'bg-orange-500';
                    textClass = 'text-white';
                } else if ((userId + 4) % 6 === 0) {
                    bgClass = 'bg-pink-500';
                    textClass = 'text-white';
                }
                
                chatAvatar.className = `w-12 h-12 rounded-full ${bgClass} flex items-center justify-center ${textClass} font-bold text-lg shadow-lg`;
            }
        }
    }
    
    async loadMessages(userId, messageTypeId = null) {
        if (this.isLoading) return;
        
        this.isLoading = true;
        const messagesList = document.getElementById('messages-list');
        
        try {
            // Build URL with message type parameter if provided
            let url = `/messages/api/messages/${userId}/`;
            if (messageTypeId !== null && messageTypeId !== undefined) {
                url += `?message_type_id=${messageTypeId}`;
            }
            
            // Debug: console.log('Loading messages with URL:', url, 'MessageTypeId:', messageTypeId);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.messages) {
                // Clear existing messages
                if (messagesList) {
                    messagesList.innerHTML = '';
                    
                    // Add messages with animation
                    data.messages.forEach((message, index) => {
                        setTimeout(() => {
                            const messageElement = this.createMessageElement(message);
                            messagesList.appendChild(messageElement);
                        }, index * 50); // Stagger animation
                    });
                    
                    // Scroll to bottom after all messages are loaded
                    setTimeout(() => {
                        this.scrollToBottom();
                    }, data.messages.length * 50 + 100);
                }
                
                this.lastMessageCount = data.messages.length;
            }
        } catch (error) {
            console.error('Error loading messages:', error);
            this.showError('Failed to load messages');
        } finally {
            this.isLoading = false;
        }
    }
    
    createMessageElement(message) {
        const messageDiv = document.createElement('div');
        const isOwnMessage = message.sender_id == {{ user.id }};
        
        messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-4 message-enter`;
        
        const timestamp = this.formatTime(message.timestamp);
        const messageContent = this.escapeHtml(message.content);
        
        messageDiv.innerHTML = `
            <div class="max-w-[70%] group">
                <div class="px-4 py-3 rounded-2xl shadow-md ${isOwnMessage 
                    ? 'bg-lime text-black shadow-lime/20' 
                    : 'bg-gray-800 text-white border border-gray-600 shadow-gray-900/20'} 
                    ${isOwnMessage ? 'rounded-br-md' : 'rounded-bl-md'}">
                    <p class="text-sm leading-relaxed whitespace-pre-wrap">${messageContent}</p>
                </div>
                <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mt-1">
                    <span class="text-xs text-gray-500 px-2 opacity-70 group-hover:opacity-100 transition-opacity">
                        ${timestamp}
                    </span>
                </div>
            </div>
        `;
        
        return messageDiv;
    }
    
    async sendMessage() {
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        
        if (!messageInput || !sendButton) return;
        
        const messageText = messageInput.value.trim();
        
        if (!messageText || !this.currentUserId || this.isLoading) {
            return;
        }
        
        // Disable send button and show loading state
        sendButton.disabled = true;
        const originalButtonContent = sendButton.innerHTML;
        sendButton.innerHTML = `
            <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        `;
        
        try {
            // Prepare message data with current message type
            const messageData = {
                'receiver_id': this.currentUserId,
                'content': messageText
            };
            
            // Include message type if we're in a categorized conversation
            if (this.currentMessageTypeId && this.currentMessageTypeId !== 'null') {
                messageData.message_type_id = this.currentMessageTypeId;
            }
            
            const response = await fetch('/messages/api/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify(messageData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                messageInput.value = '';
                messageInput.style.height = 'auto'; // Reset height
                
                // Hide character counter
                const charCounter = document.getElementById('char-counter');
                if (charCounter) charCounter.classList.add('hidden');
                
                // Reload messages to show the new message
                await this.loadMessages(this.currentUserId, this.currentMessageTypeId);
                
                // Update conversation list (optional - refresh latest message)
                this.updateConversationPreview(messageText);
                
            } else {
                this.showError('Error sending message: ' + data.error);
            }
        } catch (error) {
            console.error('Error sending message:', error);
            this.showError('Failed to send message');
        } finally {
            // Restore send button
            sendButton.innerHTML = originalButtonContent;
            sendButton.disabled = messageInput.value.trim().length === 0;
        }
    }
    
    updateConversationPreview(messageText) {
        const currentConversation = document.querySelector('.conversation-item.bg-zinc-900');
        if (currentConversation) {
            const previewElement = currentConversation.querySelector('p');
            if (previewElement) {
                previewElement.innerHTML = `<span class="text-lime font-medium">You:</span> ${messageText.substring(0, 30)}${messageText.length > 30 ? '...' : ''}`;
            }
        }
    }
    
    startMessagePolling() {
        this.stopMessagePolling();
        
        // Poll for new messages every 5 seconds when chat is active
        this.messagePolling = setInterval(async () => {
            if (this.currentUserId && !this.isLoading) {
                try {
                    // Build URL with message type parameter for polling
                    let url = `/messages/api/messages/${this.currentUserId}/`;
                    if (this.currentMessageTypeId !== null && this.currentMessageTypeId !== undefined) {
                        url += `?message_type_id=${this.currentMessageTypeId}`;
                    }
                    
                    // Debug: console.log('Polling messages with URL:', url);
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.success && data.messages && data.messages.length > this.lastMessageCount) {
                        // New messages available, reload with message type filter
                        await this.loadMessages(this.currentUserId, this.currentMessageTypeId);
                    }
                } catch (error) {
                    console.error('Error polling messages:', error);
                }
            }
        }, 5000);
    }
    
    stopMessagePolling() {
        if (this.messagePolling) {
            clearInterval(this.messagePolling);
            this.messagePolling = null;
        }
    }
    
    scrollToBottom() {
        const messagesContainer = document.getElementById('messages-container');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    
    showError(message) {
        // Create a toast notification
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
    
    formatTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInMinutes = Math.floor((now - date) / 60000);
        
        if (diffInMinutes < 1) return 'Just now';
        if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
        if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
        
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    getCSRFToken() {
        return '{{ csrf_token }}';
    }
    
    showMobileChat() {
        if (window.innerWidth <= 768) {
            document.body.classList.add('mobile-chat-open');
        }
    }
    
    hideMobileChat() {
        document.body.classList.remove('mobile-chat-open');
    }
    
    cleanup() {
        this.stopMessagePolling();
        if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
        }
    }
}

// Initialize the messaging app when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.messagingApp = new MessagingApp();
});
</script>
{% endblock %}