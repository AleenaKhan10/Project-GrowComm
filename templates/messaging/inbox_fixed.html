{% extends 'base.html' %}

{% block title %}Messages - GrowCommunity{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50 -mt-4">
    <!-- Left sidebar - Conversations list -->
    <div class="w-1/3 bg-white border-r border-gray-200 flex flex-col">
        <!-- Header -->
        <div class="p-4 border-b border-gray-100 bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-900 mb-3">Messages</h2>
            <div class="relative">
                <input 
                    type="text" 
                    placeholder="Search conversations..." 
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                <svg class="absolute left-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
        </div>
        
        <!-- Conversations list -->
        <div class="flex-1 overflow-y-auto">
            {% if conversations %}
                {% for conversation in conversations %}
                    {% for participant in conversation.participants.all %}
                        {% if participant != user %}
                        <div class="conversation-item p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors {% if forloop.first %}bg-blue-50 border-l-4 border-blue-500{% endif %}" 
                             onclick="selectConversation({{ conversation.id }}, '{{ participant.profile.display_name|default:participant.username|escapejs }}', {{ participant.id }})">
                            <div class="flex items-center space-x-3">
                                <!-- Avatar -->
                                <div class="relative">
                                    {% if participant.profile.profile_picture %}
                                        <img src="{{ participant.profile.profile_picture.url }}" 
                                             alt="{{ participant.profile.display_name|default:participant.username }}" 
                                             class="w-12 h-12 rounded-full object-cover">
                                    {% else %}
                                        <div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white font-medium text-sm">
                                            {{ participant.first_name|first|default:participant.username|first|upper }}
                                        </div>
                                    {% endif %}
                                    <!-- Online status -->
                                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 border-2 border-white rounded-full"></div>
                                </div>
                                
                                <!-- Conversation info -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-1">
                                        <h3 class="text-sm font-medium text-gray-900 truncate">
                                            {{ participant.profile.display_name|default:participant.username }}
                                        </h3>
                                        {% if conversation.latest_message %}
                                            <span class="text-xs text-gray-500">
                                                {{ conversation.latest_message.created_date|timesince }} ago
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <p class="text-sm text-gray-600 truncate">
                                            {% if conversation.latest_message %}
                                                {% if conversation.latest_message.sender == user %}You: {% endif %}
                                                {{ conversation.latest_message.content|truncatewords:6 }}
                                            {% else %}
                                                <span class="text-blue-500">Start a conversation</span>
                                            {% endif %}
                                        </p>
                                        <!-- Unread count -->
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% else %}
                <div class="flex flex-col items-center justify-center p-8 text-center">
                    <svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.966 8.966 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"/>
                    </svg>
                    <h3 class="text-sm font-medium text-gray-900 mb-2">No conversations yet</h3>
                    <p class="text-sm text-gray-500 mb-4">Start messaging community members to begin conversations.</p>
                    <a href="{% url 'communities:user_list' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 919.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Browse Community
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Right side - Chat area -->
    <div class="flex-1 flex flex-col">
        <!-- Chat header -->
        <div id="chat-header" class="p-4 bg-white border-b border-gray-200 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div id="chat-avatar" class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-medium">
                        A
                    </div>
                    <div>
                        <h3 id="chat-name" class="text-lg font-medium text-gray-900">Select a conversation</h3>
                        <p class="text-sm text-green-500">Online</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                    </button>
                    <button class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Messages area -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 bg-gray-50">
            <div id="messages-list" class="space-y-4">
                <!-- Messages will be loaded here -->
            </div>
            
            <!-- Default state -->
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center">
                <svg class="w-20 h-20 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.966 8.966 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"/>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Welcome to Messages</h3>
                <p class="text-gray-600 mb-6">Select a conversation from the sidebar to start messaging</p>
            </div>
        </div>
        
        <!-- Message input -->
        <div id="message-input-area" class="p-4 bg-white border-t border-gray-200 hidden">
            <div class="flex items-end space-x-3">
                <button class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                    </svg>
                </button>
                <div class="flex-1">
                    <textarea 
                        id="message-input" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                        rows="1" 
                        placeholder="Type a message..."
                        onkeydown="handleMessageInput(event)"
                    ></textarea>
                </div>
                <button 
                    id="send-button" 
                    onclick="sendMessage()"
                    class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors"
                >
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversationId = null;
let currentUserId = null;
let currentUserName = '';

// Auto-select first conversation if available
{% if conversations %}
document.addEventListener('DOMContentLoaded', function() {
    const firstConversation = document.querySelector('.conversation-item');
    if (firstConversation) {
        firstConversation.click();
    }
});
{% endif %}

function selectConversation(conversationId, userName, userId) {
    currentConversationId = conversationId;
    currentUserId = userId;
    currentUserName = userName;
    
    // Update UI highlighting
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
    });
    event.currentTarget.classList.add('bg-blue-50', 'border-l-4', 'border-blue-500');
    
    // Show chat interface
    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('chat-header').classList.remove('hidden');
    document.getElementById('message-input-area').classList.remove('hidden');
    
    // Update chat header
    document.getElementById('chat-name').textContent = userName;
    document.getElementById('chat-avatar').textContent = userName.charAt(0).toUpperCase();
    
    // Load messages
    loadMessages(userId);
}

function loadMessages(userId) {
    fetch(`/messages/api/conversation/${userId}/`)
        .then(response => response.json())
        .then(data => {
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = '';
            
            if (data.success && data.messages) {
                data.messages.forEach(message => {
                    const messageDiv = createMessageElement(message);
                    messagesList.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                document.getElementById('messages-container').scrollTop = 
                    document.getElementById('messages-container').scrollHeight;
            }
        })
        .catch(error => {
            console.error('Error loading messages:', error);
        });
}

function createMessageElement(message) {
    const messageDiv = document.createElement('div');
    const isOwnMessage = message.sender_id == {{ user.id }};
    
    messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-4`;
    
    messageDiv.innerHTML = `
        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isOwnMessage 
            ? 'bg-blue-600 text-white' 
            : 'bg-white text-gray-900 border border-gray-200'}">
            <p class="text-sm">${message.content}</p>
            <p class="text-xs ${isOwnMessage ? 'text-blue-100' : 'text-gray-500'} mt-1">
                ${formatTime(message.timestamp)}
            </p>
        </div>
    `;
    
    return messageDiv;
}

function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const messageText = messageInput.value.trim();
    
    if (!messageText || !currentUserId) {
        return;
    }
    
    fetch('/messages/api/send/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            'receiver_id': currentUserId,
            'content': messageText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            loadMessages(currentUserId); // Reload messages
        } else {
            alert('Error sending message: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Error sending message');
    });
}

function handleMessageInput(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function formatTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInMinutes = Math.floor((now - date) / 60000);
    
    if (diffInMinutes < 1) return 'Just now';
    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
    if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
    return date.toLocaleDateString();
}
</script>
{% endblock %}