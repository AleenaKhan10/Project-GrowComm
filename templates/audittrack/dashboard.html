{% extends 'base.html' %}

{% block title %}Audit Dashboard - GrwComm{% endblock %}

{% block content %}
<div class="container py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-light text-black">Audit Dashboard</h1>
        <div class="text-sm text-gray-600">User Activity Analytics</div>
    </div>

    <!-- Time Filter -->
    <div class="card mb-6">
        <div class="flex flex-wrap gap-3">
            <button onclick="changeTimeFilter('today')" id="filter-today" class="filter-btn px-4 py-2 text-sm font-medium rounded transition-colors">Today</button>
            <button onclick="changeTimeFilter('last_24_hours')" id="filter-last_24_hours" class="filter-btn px-4 py-2 text-sm font-medium rounded transition-colors">Last 24 Hours</button>
            <button onclick="changeTimeFilter('last_6_days')" id="filter-last_6_days" class="filter-btn px-4 py-2 text-sm font-medium rounded transition-colors">Last 6 Days</button>
            <button onclick="changeTimeFilter('last_30_days')" id="filter-last_30_days" class="filter-btn px-4 py-2 text-sm font-medium rounded transition-colors">Last 30 Days</button>
        </div>
    </div>

    <!-- Statistics Cards - Mobile optimized 2-column grid -->
    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-1 sm:gap-2 md:gap-4 mb-6">
        <!-- Sign Ins -->
        <div class="card">
            <div class="flex items-center justify-between overflow-hidden">
                <div class="w-full overflow-hidden">
                    <div class="text-sm text-gray-600 font-medium">Total Sign Ins</div>
                    <div id="stat-signins" class="text-2xl font-light text-black mt-1">0</div>
                </div>
            </div>
        </div>

        <!-- Sign Outs -->
        <div class="card">
            <div class="flex items-center justify-between overflow-hidden">
                <div class="w-full overflow-hidden">
                    <div class="text-sm text-gray-600 font-medium">Total Sign Outs</div>
                    <div id="stat-signouts" class="text-2xl font-light text-black mt-1">0</div>
                </div>
            </div>
        </div>

        <!-- Invites Created -->
        <div class="card">
            <div class="flex items-center justify-between overflow-hidden">
                <div class="w-full overflow-hidden">
                    <div class="text-sm text-gray-600 font-medium">Invites Created</div>
                    <div id="stat-invites" class="text-2xl font-light text-black mt-1">0</div>
                </div>
            </div>
        </div>

        <!-- User Registrations -->
        <div class="card">
            <div class="flex items-center justify-between overflow-hidden">
                <div class="w-full overflow-hidden">
                    <div class="text-sm text-gray-600 font-medium">User Registrations</div>
                    <div id="stat-registrations" class="text-2xl font-light text-black mt-1">0</div>
                </div>
            </div>
        </div>

        <!-- Referrals -->
        <div class="card">
            <div class="flex items-center justify-between overflow-hidden">
                <div class="w-full overflow-hidden">
                    <div class="text-sm text-gray-600 font-medium">Referrals Sent</div>
                    <div id="stat-referrals" class="text-2xl font-light text-black mt-1">0</div>
                </div>
            </div>
        </div>

        <!-- Slots Opened -->
        <div class="card">
            <div class="flex items-center justify-between overflow-hidden">
                <div class="w-full overflow-hidden">
                    <div class="text-sm text-gray-600 font-medium">Slots Opened</div>
                    <div id="stat-slots" class="text-2xl font-light text-black mt-1">0</div>
                </div>
            </div>
        </div>

        <!-- Users Deleted -->
        <div class="card">
            <div class="flex items-center justify-between overflow-hidden">
                <div class="w-full overflow-hidden">
                    <div class="text-sm text-gray-600 font-medium">Users Deleted</div>
                    <div id="stat-users-deleted" class="text-2xl font-light text-black mt-1">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Logs Table -->
    <div class="card overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-light text-black">Recent Activity</h3>
        </div>
        
        <!-- Desktop table view -->
        <div class="hidden md:block overflow-x-auto">
            <table class="table min-w-full">
                <thead>
                    <tr>
                        <th class="text-left">User</th>
                        <th class="text-left">Action</th>
                        <th class="text-left">Target User</th>
                        <th class="text-left">Details</th>
                        <th class="text-left">Time</th>
                    </tr>
                </thead>
                <tbody id="logs-table-body">
                    <!-- Will be populated via JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Mobile list view -->
        <div class="block md:hidden" id="logs-mobile-list">
            <!-- Will be populated via JavaScript -->
        </div>

        <!-- Loading state -->
        <div id="logs-loading" class="px-6 py-8 text-center text-gray-500">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div>
            <div class="mt-2">Loading audit logs...</div>
        </div>

        <!-- Empty state -->
        <div id="logs-empty" class="px-6 py-8 text-center text-gray-500 hidden">
            <div class="text-sm">No audit logs found for the selected time period.</div>
        </div>

        <!-- Load more button -->
        <div id="load-more-container" class="px-6 py-4 border-t border-gray-200 text-center hidden">
            <button onclick="loadMoreLogs()" id="load-more-btn" class="px-4 py-2 bg-black text-white text-sm font-medium rounded hover:bg-gray-800 transition-colors">
                Load More
            </button>
        </div>
    </div>
</div>

<style>
/* Filter buttons styling */
.filter-btn {
    background-color: white;
    color: #374151;
    border: 1px solid #d1d5db;
}

.filter-btn:hover {
    background-color: #f9fafb;
}

.filter-btn.active {
    background-color: black;
    color: white;
    border-color: black;
}

/* Card styling to match existing design */
.card {
    background-color: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    padding: 1.5rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th {
    background-color: #f9fafb;
    padding: 0.75rem 1.5rem;
    text-align: left;
    font-weight: 500;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.875rem;
}

.table td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #f3f4f6;
    font-size: 0.875rem;
}

.table tbody tr:hover {
    background-color: #f9fafb;
}

<!-- Page inherits mobile styling from base.html -->

/* Log item styling for mobile */
.log-item {
    padding: 1rem;
    border-bottom: 1px solid #f3f4f6;
}

.log-item:last-child {
    border-bottom: none;
}

.log-item:hover {
    background-color: #f9fafb;
}

</style>

<script>
let currentFilter = 'today';
let currentPage = 1;
let hasMoreLogs = true;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    setActiveFilter('today');
    loadStatistics();
    loadAuditLogs();
});

// Change time filter
function changeTimeFilter(filter) {
    currentFilter = filter;
    currentPage = 1;
    hasMoreLogs = true;
    setActiveFilter(filter);
    loadStatistics();
    loadAuditLogs();
}

// Set active filter button
function setActiveFilter(filter) {
    // Remove active class from all buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to selected button
    document.getElementById(`filter-${filter}`).classList.add('active');
}

// Load statistics from API
function loadStatistics() {
    fetch(`/audit/api/statistics/?filter=${currentFilter}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('stat-signins').textContent = data.total_signins || 0;
            document.getElementById('stat-signouts').textContent = data.total_signouts || 0;
            document.getElementById('stat-invites').textContent = data.total_invites || 0;
            document.getElementById('stat-registrations').textContent = data.total_registrations || 0;
            document.getElementById('stat-referrals').textContent = data.total_referrals || 0;
            document.getElementById('stat-slots').textContent = data.total_slots_opened || 0;
            document.getElementById('stat-users-deleted').textContent = data.total_users_deleted || 0;
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
            showNotification('Error loading statistics', 'error');
        });
}

// Load audit logs from API
function loadAuditLogs(append = false) {
    if (!append) {
        document.getElementById('logs-loading').classList.remove('hidden');
        document.getElementById('logs-empty').classList.add('hidden');
        document.getElementById('load-more-container').classList.add('hidden');
    }

    fetch(`/audit/api/logs/?page=${currentPage}&per_page=20`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('logs-loading').classList.add('hidden');
            
            if (data.logs && data.logs.length > 0) {
                if (append) {
                    appendLogsToTable(data.logs);
                    appendLogsToMobile(data.logs);
                } else {
                    populateLogsTable(data.logs);
                    populateLogsMobile(data.logs);
                }
                
                // Show/hide load more button
                if (data.pagination.has_next) {
                    document.getElementById('load-more-container').classList.remove('hidden');
                } else {
                    document.getElementById('load-more-container').classList.add('hidden');
                    hasMoreLogs = false;
                }
            } else if (!append) {
                document.getElementById('logs-empty').classList.remove('hidden');
                document.getElementById('logs-table-body').innerHTML = '';
                document.getElementById('logs-mobile-list').innerHTML = '';
            }
        })
        .catch(error => {
            console.error('Error loading audit logs:', error);
            document.getElementById('logs-loading').classList.add('hidden');
            showNotification('Error loading audit logs', 'error');
        });
}

// Populate desktop table
function populateLogsTable(logs) {
    const tbody = document.getElementById('logs-table-body');
    tbody.innerHTML = '';
    
    logs.forEach(log => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4">
                <div class="text-sm font-medium text-black">${log.user}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-600">${log.action}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-600">${log.target_user || '-'}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-600">${log.action_detail || '-'}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-600">${formatDateTime(log.timestamp)}</div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Append to desktop table (for load more)
function appendLogsToTable(logs) {
    const tbody = document.getElementById('logs-table-body');
    
    logs.forEach(log => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4">
                <div class="text-sm font-medium text-black">${log.user}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-600">${log.action}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-600">${log.target_user || '-'}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-600">${log.action_detail || '-'}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-600">${formatDateTime(log.timestamp)}</div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Populate mobile list
function populateLogsMobile(logs) {
    const container = document.getElementById('logs-mobile-list');
    container.innerHTML = '';
    
    logs.forEach(log => {
        const item = document.createElement('div');
        item.className = 'log-item';
        item.innerHTML = `
            <div class="flex justify-between items-start gap-2">
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-black truncate">${log.user}</div>
                    <div class="text-sm text-gray-600 mt-1">${log.action}</div>
                    ${log.target_user ? `<div class="text-xs text-blue-600 mt-1">Target: ${log.target_user}</div>` : ''}
                    ${log.action_detail ? `<div class="text-xs text-gray-500 mt-1 break-words">${log.action_detail}</div>` : ''}
                </div>
                <div class="text-xs text-gray-500 flex-shrink-0 ml-2">${formatDateTime(log.timestamp)}</div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Append to mobile list (for load more)
function appendLogsToMobile(logs) {
    const container = document.getElementById('logs-mobile-list');
    
    logs.forEach(log => {
        const item = document.createElement('div');
        item.className = 'log-item';
        item.innerHTML = `
            <div class="flex justify-between items-start gap-2">
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-black truncate">${log.user}</div>
                    <div class="text-sm text-gray-600 mt-1">${log.action}</div>
                    ${log.target_user ? `<div class="text-xs text-blue-600 mt-1">Target: ${log.target_user}</div>` : ''}
                    ${log.action_detail ? `<div class="text-xs text-gray-500 mt-1 break-words">${log.action_detail}</div>` : ''}
                </div>
                <div class="text-xs text-gray-500 flex-shrink-0 ml-2">${formatDateTime(log.timestamp)}</div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Load more logs
function loadMoreLogs() {
    if (hasMoreLogs) {
        currentPage++;
        loadAuditLogs(true);
    }
}

// Format datetime for display - show actual timestamp
function formatDateTime(isoString) {
    const date = new Date(isoString);
    
    // Format: Dec 12, 2024 3:45 PM
    const options = {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    };
    
    return date.toLocaleDateString('en-US', options);
}

// Show notification (reuse from existing code)
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white font-medium z-50 transform transition-all duration-300 translate-x-full max-w-sm mx-4 md:mx-0`;
    
    // Set color based on type
    switch(type) {
        case 'success':
            notification.style.background = '#10B981';
            break;
        case 'error':
            notification.style.background = '#EF4444';
            break;
        case 'warning':
            notification.style.background = '#F59E0B';
            break;
        default:
            notification.style.background = '#3B82F6';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 10);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}
</script>
{% endblock %}